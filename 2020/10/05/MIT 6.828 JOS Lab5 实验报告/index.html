<!DOCTYPE html><html lang="en" theme-mode="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>MIT 6.828 JOS Lab5 实验报告 | Renze Chen (陈仁泽)</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
@font-face {
  font-family: 'Fira Code';
  src: local('Fira Code'), url('/font/FiraCode-Regular.ttf');
}
@font-face {
  font-family: 'Monaco';
  src: local('Monaco'), url('/font/Monaco.ttf');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/imgs/bk-dark-0.png');
 --light-background: url('/imgs/bk-light-5.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Blogs</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>MIT 6.828 JOS Lab5 实验报告</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2020-10-05T01:48:00.000Z" id="date"> 2020-10-05</time></div></span><br><span>Blog Link: <div class="control"> <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/261880475">[site]</a></div></span></div></div><hr><div id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此为本人上本校的操作系统实习(实验班)时所写的实验报告，简单记述了JOS Lab的各个Exercise、Challenge(未覆盖所有Challenge，每个Lab大概做了1~3个Challenge)的基本思路。仅供有需者参考，上有关课程(比如本校的操统实习实验班)的最好不要直接抄。</p>
<p>附上源代码链接：<a href="https://link.zhihu.com/?target=https://github.com/Light-of-Hers/mit-jos">https://github.com/Light-of-Hers/mit-jos</a></p>
<h2 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h2><p>在<code>env_create</code>函数中加入如下语句即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (type == ENV_TYPE_FS) <br>    e-&gt;env_tf.tf_eflags |= FL_IOPL_MASK;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Q: Do you have to do anything else to ensure that this I/O privilege setting is saved and restored properly when you subsequently switch from one environment to another? Why?</p>
<p>A: 不需要，因为IO权限保存在EFLAGS中，而上下文切换时会保存/恢复EFLAGS</p>
</blockquote>
<h2 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h2><h3 id="bc-pgfault"><a href="#bc-pgfault" class="headerlink" title="bc_pgfault"></a><code>bc_pgfault</code></h3><p>按要求完成即可。关于为什么先读取磁盘块再判断是否空闲，个人认为是因为读取的磁盘块可能是本身就是bitmap的一部分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Allocate a page in the disk map region, read the contents</span><br><span class="hljs-comment">// of the block from the disk into that page.</span><br><span class="hljs-comment">// Hint: first round addr to page boundary. fs/ide.c has code to read</span><br><span class="hljs-comment">// the disk.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// LAB 5: you code here:</span><br>addr = ROUNDDOWN(addr, BLKSIZE);<br><span class="hljs-keyword">if</span> (r = sys_page_alloc(<span class="hljs-number">0</span>, addr, PTE_P | PTE_U | PTE_W), r &lt; <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">"in bc_pgfault, sys_page_alloc: %e"</span>, r);<br><span class="hljs-keyword">if</span> (r = ide_read(blockno * BLKSECTS, addr, BLKSECTS), r &lt; <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">"in bc_pgfault, ide_read: %e"</span>, r);<br><br><span class="hljs-comment">// Clear the dirty bit for the disk block page since we just read the</span><br><span class="hljs-comment">// block from disk</span><br><span class="hljs-keyword">if</span> ((r = sys_page_map(<span class="hljs-number">0</span>, addr, <span class="hljs-number">0</span>, addr, uvpt[PGNUM(addr)] &amp; PTE_SYSCALL)) &lt; <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">"in bc_pgfault, sys_page_map: %e"</span>, r);<br><br><span class="hljs-comment">// Check that the block we read was allocated. (exercise for</span><br><span class="hljs-comment">// the reader: why do we do this *after* reading the block</span><br><span class="hljs-comment">// in?)</span><br><span class="hljs-comment">// perhaps it's the bitmap block, therefore reading the block before checking the bitmap</span><br><span class="hljs-keyword">if</span> (bitmap &amp;&amp; block_is_free(blockno))<br>    panic(<span class="hljs-string">"reading free block %08x\n"</span>, blockno);<br></code></pre></td></tr></table></figure>

<h3 id="flush-block"><a href="#flush-block" class="headerlink" title="flush_block"></a><code>flush_block</code></h3><p>按要求完成即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">flush_block</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>{<br>    <span class="hljs-type">uint32_t</span> blockno = ((<span class="hljs-type">uint32_t</span>)addr - DISKMAP) / BLKSIZE;<br><br>    <span class="hljs-keyword">if</span> (addr &lt; (<span class="hljs-type">void</span>*)DISKMAP || addr &gt;= (<span class="hljs-type">void</span>*)(DISKMAP + DISKSIZE))<br>        panic(<span class="hljs-string">"flush_block of bad va %08x"</span>, addr);<br><br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-comment">// panic("flush_block not implemented");</span><br>    <span class="hljs-type">int</span> r;<br><br>    addr = ROUNDDOWN(addr, BLKSIZE);<br>    <span class="hljs-keyword">if</span> (!va_is_mapped(addr) || !va_is_dirty(addr))<br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-keyword">if</span> (r = ide_write(blockno * BLKSECTS, addr, BLKSECTS), r &lt; <span class="hljs-number">0</span>)<br>        panic(<span class="hljs-string">"in flush_block, ide_write: %e"</span>, r);<br><br>    <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, addr, <span class="hljs-number">0</span>, addr, uvpt[PGNUM(addr)] &amp; PTE_SYSCALL), r &lt; <span class="hljs-number">0</span>)<br>        panic(<span class="hljs-string">"in flush_block, sys_page_map: %e"</span>, r);<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h2><p>按顺序搜索空闲块即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span><br><span class="hljs-title function_">alloc_block</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>    <span class="hljs-comment">// The bitmap consists of one or more blocks.  A single bitmap block</span><br>    <span class="hljs-comment">// contains the in-use bits for BLKBITSIZE blocks.  There are</span><br>    <span class="hljs-comment">// super-&gt;s_nblocks blocks in the disk altogether.</span><br><br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-comment">// panic("alloc_block not implemented");</span><br>    <span class="hljs-type">int</span> blockno;<br><br>    <span class="hljs-keyword">if</span> (!super)<br>        panic(<span class="hljs-string">"no super block"</span>);<br><br>    <span class="hljs-keyword">for</span> (blockno = <span class="hljs-number">0</span>; blockno &lt; super-&gt;s_nblocks; ++blockno)<br>        <span class="hljs-keyword">if</span> (block_is_free(blockno))<br>            <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> (blockno == super-&gt;s_nblocks)<br>        <span class="hljs-keyword">return</span> -E_NO_DISK;<br><br>    bitmap[blockno / <span class="hljs-number">32</span>] &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; (blockno % <span class="hljs-number">32</span>));<br>    flush_block(bitmap);<br>    <span class="hljs-keyword">return</span> blockno;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h2><h3 id="file-block-walk"><a href="#file-block-walk" class="headerlink" title="file_block_walk"></a><code>file_block_walk</code></h3><p>先寻找直接块，再寻找间接块，必要时分配一个间接块：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">file_block_walk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> File *f, <span class="hljs-type">uint32_t</span> filebno, <span class="hljs-type">uint32_t</span> **ppdiskbno, <span class="hljs-type">bool</span> alloc)</span><br>{<br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-comment">// panic("file_block_walk not implemented");</span><br>    <span class="hljs-keyword">if</span> (filebno &lt; NDIRECT) {<br>        *ppdiskbno = &amp;f-&gt;f_direct[filebno];<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>    filebno -= NDIRECT;<br><br>    <span class="hljs-keyword">if</span> (filebno &lt; NINDIRECT) {<br>        <span class="hljs-keyword">if</span> (f-&gt;f_indirect == <span class="hljs-number">0</span>) {<br>            <span class="hljs-keyword">if</span> (!alloc)<br>                <span class="hljs-keyword">return</span> -E_NOT_FOUND;<br>            <span class="hljs-type">int</span> blockno = alloc_block();<br>            <span class="hljs-keyword">if</span> (blockno &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> blockno;<br>            f-&gt;f_indirect = (<span class="hljs-type">uint32_t</span>)blockno;<br>            <span class="hljs-built_in">memset</span>(diskaddr(f-&gt;f_indirect), <span class="hljs-number">0</span>, BLKSIZE);<br>        }<br>        <span class="hljs-type">uint32_t</span> *ind_blk = (<span class="hljs-type">uint32_t</span>*)diskaddr(f-&gt;f_indirect);<br>        *ppdiskbno = &amp;ind_blk[filebno];<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br><br>    <span class="hljs-keyword">return</span> -E_INVAL;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="file-get-block"><a href="#file-get-block" class="headerlink" title="file_get_block"></a><code>file_get_block</code></h3><p>利用<code>file_block_walk</code>寻找对应的slot，得到对应的块号（必要时分配一个块），之后返回磁盘块对应的内存地址即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span><br><span class="hljs-title function_">file_get_block</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> File *f, <span class="hljs-type">uint32_t</span> filebno, <span class="hljs-type">char</span> **blk)</span><br>{<br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-comment">// panic("file_get_block not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">uint32_t</span> *diskbno;<br>    <br>    <span class="hljs-keyword">if</span> (r = file_block_walk(f, filebno, &amp;diskbno, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (*diskbno == <span class="hljs-number">0</span>) {<br>        <span class="hljs-keyword">if</span> (r = alloc_block(), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>        *diskbno = (<span class="hljs-type">uint32_t</span>)r;<br>    }<br>    *blk = (<span class="hljs-type">char</span>*)diskaddr(*diskbno);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h2><p>模仿<code>serve_set_size</code>，利用<code>file_read</code>实现即可。注意最后要更新文件的offset。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span><br><span class="hljs-title function_">serve_read</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-keyword">union</span> Fsipc *ipc)</span><br>{<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Fsreq_read</span> *<span class="hljs-title">req</span> =</span> &amp;ipc-&gt;read;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Fsret_read</span> *<span class="hljs-title">ret</span> =</span> &amp;ipc-&gt;readRet;<br><br>    <span class="hljs-keyword">if</span> (debug)<br>        cprintf(<span class="hljs-string">"serve_read %08x %08x %08x\n"</span>, envid, req-&gt;req_fileid, req-&gt;req_n);<br><br>    <span class="hljs-comment">// Lab 5: Your code here:</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">OpenFile</span> *<span class="hljs-title">o</span>;</span><br><br>    <span class="hljs-keyword">if</span> (r = openfile_lookup(envid, req-&gt;req_fileid, &amp;o), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (r = file_read(o-&gt;o_file, ret-&gt;ret_buf, req-&gt;req_n, o-&gt;o_fd-&gt;fd_offset), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    o-&gt;o_fd-&gt;fd_offset += r;<br>    <span class="hljs-keyword">return</span> r;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-6"><a href="#Exercise-6" class="headerlink" title="Exercise 6"></a>Exercise 6</h2><h3 id="serve-write"><a href="#serve-write" class="headerlink" title="serve_write"></a><code>serve_write</code></h3><p>和<code>serve_read</code>实现类似：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span><br><span class="hljs-title function_">serve_write</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-keyword">struct</span> Fsreq_write *req)</span><br>{<br>    <span class="hljs-keyword">if</span> (debug)<br>        cprintf(<span class="hljs-string">"serve_write %08x %08x %08x\n"</span>, envid, req-&gt;req_fileid, req-&gt;req_n);<br><br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-comment">// panic("serve_write not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">OpenFile</span> *<span class="hljs-title">o</span>;</span><br><br>    <span class="hljs-keyword">if</span> (r = openfile_lookup(envid, req-&gt;req_fileid, &amp;o), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (r = file_write(o-&gt;o_file, req-&gt;req_buf, req-&gt;req_n, o-&gt;o_fd-&gt;fd_offset), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    o-&gt;o_fd-&gt;fd_offset += r;<br>    <span class="hljs-keyword">return</span> r;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="devfile-write"><a href="#devfile-write" class="headerlink" title="devfile_write"></a><code>devfile_write</code></h3><p>模仿<code>devfile_read</code>实现即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">devfile_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Fd *fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> n)</span><br>{<br>    <span class="hljs-comment">// Make an FSREQ_WRITE request to the file system server.  Be</span><br>    <span class="hljs-comment">// careful: fsipcbuf.write.req_buf is only so large, but</span><br>    <span class="hljs-comment">// remember that write is always allowed to write *fewer*</span><br>    <span class="hljs-comment">// bytes than requested.</span><br>    <span class="hljs-comment">// LAB 5: Your code here</span><br>    <span class="hljs-comment">// panic("devfile_write not implemented");</span><br>    <span class="hljs-type">int</span> r;<br><br>    assert(n &lt;= <span class="hljs-keyword">sizeof</span>(fsipcbuf.write.req_buf));<br><br>    fsipcbuf.write.req_fileid = fd-&gt;fd_file.id;<br>    fsipcbuf.write.req_n = n;<br>    memmove(fsipcbuf.write.req_buf, buf, n);<br><br>    <span class="hljs-keyword">if</span> (r = fsipc(FSREQ_WRITE, <span class="hljs-literal">NULL</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br><br>    assert(r &lt;= n);<br><br>    <span class="hljs-keyword">return</span> r;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h2><p>按要求设置一些必要的控制/状态寄存器即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_env_set_trapframe</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>{<br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-comment">// Remember to check whether the user has supplied us with a good</span><br>    <span class="hljs-comment">// address!</span><br>    <span class="hljs-comment">// panic("sys_env_set_trapframe not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">e</span>;</span><br><br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;e, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br><br>    e-&gt;env_tf = *tf;<br>    tf = &amp;e-&gt;env_tf;<br><br>    tf-&gt;tf_eflags |= FL_IF;<br>    tf-&gt;tf_eflags &amp;= ~FL_IOPL_MASK;<br>    tf-&gt;tf_cs |= GD_UT | <span class="hljs-number">3</span>;<br>    tf-&gt;tf_ds |= GD_UD | <span class="hljs-number">3</span>;<br>    tf-&gt;tf_es |= GD_UD | <span class="hljs-number">3</span>;<br>    tf-&gt;tf_ss |= GD_UD | <span class="hljs-number">3</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h2><h3 id="duppage"><a href="#duppage" class="headerlink" title="duppage"></a><code>duppage</code></h3><p>按要求修改映射即可。注意我将COW的优先级视作比SHARE更高，也就是如果一个页是COW的，则将其视作COW处理而不管其是否为SHARE。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">duppage</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">unsigned</span> pn)</span><br>{<br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("duppage not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">void</span> *pg;<br>    <span class="hljs-type">pte_t</span> pte;<br><br>    pg = (<span class="hljs-type">void</span>*)(pn * PGSIZE);<br>    pte = uvpt[pn];<br><br>    assert(pte &amp; PTE_P &amp;&amp; pte &amp; PTE_U);<br>    <span class="hljs-keyword">if</span> ((pte &amp; PTE_W &amp;&amp; !(pte &amp; PTE_SHARE)) || pte &amp; PTE_COW) {<br>        <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, pg, envid, pg, (pte &amp; PTE_SYSCALL &amp; ~PTE_W) | PTE_COW), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>        <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, pg, <span class="hljs-number">0</span>, pg, (pte &amp; PTE_SYSCALL &amp; ~PTE_W) | PTE_COW), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, pg, envid, pg, pte &amp; PTE_SYSCALL), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>    }<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="copy-shared-pages"><a href="#copy-shared-pages" class="headerlink" title="copy_shared_pages"></a><code>copy_shared_pages</code></h3><p>只映射标记为SHARE的页面即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">copy_shared_pages</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> child)</span><br>{<br>    <span class="hljs-comment">// LAB 5: Your code here.</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">uintptr_t</span> addr;<br><br>    <span class="hljs-keyword">for</span> (addr = <span class="hljs-number">0</span>; addr &lt; UTOP;) {<br>        <span class="hljs-keyword">if</span> (!(uvpd[PDX(addr)] &amp; PTE_P)) {<br>            addr = (<span class="hljs-type">uintptr_t</span>)PGADDR(PDX(addr) + <span class="hljs-number">1</span>, PTX(addr), PGOFF(addr));<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-type">uintptr_t</span> next = <br>                MIN((<span class="hljs-type">uintptr_t</span>)PGADDR(PDX(addr) + <span class="hljs-number">1</span>, PTX(addr), PGOFF(addr)), UTOP);<br>            <span class="hljs-keyword">for</span> (; addr &lt; next; addr += PGSIZE) {<br>                <span class="hljs-type">pte_t</span> pte = uvpt[PGNUM(addr)];<br>                <span class="hljs-keyword">if</span> (pte &amp; PTE_P &amp;&amp; pte &amp; PTE_U &amp;&amp; pte &amp; PTE_SHARE)<br>                    <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span>*)addr, <br>                                            child, (<span class="hljs-type">void</span>*)addr, pte &amp; PTE_SYSCALL), r &lt; <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">return</span> r;<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br></code></pre></td></tr></table></figure>

<h2 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h2><p>在<code>trap_dispatch</code>中添加两个处理即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Handle keyboard and serial interrupts.</span><br><span class="hljs-comment">// LAB 5: Your code here.</span><br><span class="hljs-keyword">if</span> (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_KBD) {<br>    kbd_intr();<br>    lapic_eoi();<br>    <span class="hljs-keyword">return</span>;<br><br>}<br><br><span class="hljs-keyword">if</span> (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_SERIAL) {<br>    serial_intr();<br>    lapic_eoi();<br>    <span class="hljs-keyword">return</span>;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-10"><a href="#Exercise-10" class="headerlink" title="Exercise 10"></a>Exercise 10</h2><p>模仿对输出重定向的处理即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (fd = open(t, O_RDONLY), fd &lt; <span class="hljs-number">0</span>) {<br>    cprintf(<span class="hljs-string">"open %s for read: %e"</span>, t, fd);<br>    <span class="hljs-built_in">exit</span>();<br>}<br><span class="hljs-keyword">if</span> (fd != <span class="hljs-number">0</span>) {<br>    dup(fd, <span class="hljs-number">0</span>);<br>    close(fd);<br>}<br></code></pre></td></tr></table></figure>

<h2 id="This-completes-this-lab"><a href="#This-completes-this-lab" class="headerlink" title="This completes this lab"></a>This completes this lab</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs text">internal FS tests [fs/test.c]: OK (1.4s) <br>  fs i/o: OK <br>  check_bc: OK <br>  check_super: OK <br>  check_bitmap: OK <br>  alloc_block: OK <br>  file_open: OK <br>  file_get_block: OK <br>  file_flush/file_truncate/file rewrite: OK <br>testfile: OK (1.3s) <br>  serve_open/file_stat/file_close: OK <br>  file_read: OK <br>  file_write: OK <br>  file_read after file_write: OK <br>  open: OK <br>  large file: OK <br>spawn via spawnhello: OK (0.7s) <br>Protection I/O space: OK (1.6s) <br>PTE_SHARE [testpteshare]: OK (2.3s) <br>PTE_SHARE [testfdsharing]: OK (1.1s) <br>start the shell [icode]: Timeout! OK (31.4s) <br>testshell: OK (1.9s) <br>primespipe: OK (6.8s) <br>Score: 150/150<br></code></pre></td></tr></table></figure>

<h2 id="Challenge-Disk-Buffer-Cache"><a href="#Challenge-Disk-Buffer-Cache" class="headerlink" title="Challenge: Disk Buffer Cache"></a>Challenge: Disk Buffer Cache</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>限制在物理内存中缓存的磁盘块的个数</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul>
<li>用特定结构维护当前缓存着的磁盘块信息。</li>
<li>维护一个计数器：<ul>
<li>每次对文件磁盘块访问时（调用<code>file_get_block</code>时），计数器加一。</li>
<li>当计数器达到一定量时，清空计数器，扫描所有已缓存块，将其Access位清零。</li>
</ul>
</li>
<li>当缓存块数超出上限时：<ul>
<li>扫描缓存块，释放所有Access位为0的块。</li>
<li>若找不到Access位为0的块，则释放最早缓存的一个块。</li>
</ul>
</li>
<li>一些系统保留的磁盘块（super块，bitmap块等）不考虑在内，也就是说这些保留块会永远驻留在内存中。</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>在<code>fs/bc.c</code>中实现。实现代码如下，具体说明见注释。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NCACHE 1024</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NVISIT (NCACHE / 4)</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BufferCache</span> {</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BufferCache</span> *<span class="hljs-title">bufc_free_link</span>;</span><br>	EmbedLink bufc_used_link;<br>	<span class="hljs-type">void</span> *bufc_addr;<br>} BufferCache;<br><br><span class="hljs-type">static</span> BufferCache bcaches[NCACHE];<br><span class="hljs-type">static</span> BufferCache *bufc_free;<br><span class="hljs-type">static</span> EmbedLink bufc_used;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> ncache = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> nvisit = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">bufc_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bufc_alloc</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">bufc_visit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bufc_evict</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bufc_remove</span><span class="hljs-params">(BufferCache *bc)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">is_reserved</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span>;<br><br><span class="hljs-comment">// 是否为保留块？</span><br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <br><span class="hljs-title function_">is_reserved</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>{<br>	<span class="hljs-keyword">return</span> addr &lt; diskaddr(<span class="hljs-number">2</span>);<br>}<br><br><span class="hljs-comment">// 每次page fault引入磁盘块后都会调用该函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">bufc_alloc</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>{<br>	<span class="hljs-type">int</span> r;<br><br>	<span class="hljs-comment">// 忽略保留块</span><br>	<span class="hljs-keyword">if</span> (is_reserved(addr))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">// 缓存块数达到上限，驱逐一些块</span><br>	<span class="hljs-keyword">if</span> (ncache == NCACHE) {<br>		<span class="hljs-keyword">if</span> (r = bufc_evict(), r &lt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> r;<br>	}<br>	<span class="hljs-comment">// 为addr分配一个块</span><br>	assert(bufc_free);<br>	ncache++;<br>	BufferCache *bc = bufc_free;<br>	bufc_free = bufc_free-&gt;bufc_free_link;<br>	elink_enqueue(&amp;bufc_used, &amp;bc-&gt;bufc_used_link);<br>	bc-&gt;bufc_addr = addr;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><span class="hljs-comment">// 初始化相关数据结构</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">bufc_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>	bufc_free = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NCACHE; ++i) {<br>		elink_init(&amp;bcaches[i].bufc_used_link);<br>		bcaches[i].bufc_free_link = bufc_free, bufc_free = bcaches + i;<br>		bcaches[i].bufc_addr = <span class="hljs-number">0</span>;<br>	}<br>	elink_init(&amp;bufc_used);<br>}<br><span class="hljs-comment">// 增加计数器。若达上限则扫描缓存块，将其Access位清零</span><br><span class="hljs-comment">// 注意清零之前需要flush一下，因为sys_page_map不能保留Dirty位</span><br><span class="hljs-type">int</span><br><span class="hljs-title function_">bufc_visit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>{<br>	<span class="hljs-type">int</span> r;<br><br>	<span class="hljs-keyword">if</span> (++nvisit &lt; NVISIT)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	nvisit = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">for</span> (EmbedLink *ln = bufc_used.next; ln != &amp;bufc_used; ln = ln-&gt;next) {<br>		BufferCache *bc = master(ln, BufferCache, bufc_used_link);<br>		<span class="hljs-type">void</span> *addr = bc-&gt;bufc_addr;<br>		<span class="hljs-keyword">if</span> (uvpt[PGNUM(addr)] &amp; PTE_A) {<br>			flush_block(addr);<br>			<span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, addr, <span class="hljs-number">0</span>, addr, uvpt[PGNUM(addr)] &amp; PTE_SYSCALL), r &lt; <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">return</span> r;<br>		}<br>	}<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><span class="hljs-comment">// 将缓存块的内容释放</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <br><span class="hljs-title function_">bufc_remove</span><span class="hljs-params">(BufferCache *bc)</span> <br>{<br>	<span class="hljs-type">int</span> r;<br><br>	flush_block(bc-&gt;bufc_addr);<br>	<span class="hljs-keyword">if</span> (r = sys_page_unmap(<span class="hljs-number">0</span>, bc-&gt;bufc_addr), r &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> r;<br>	ncache--;<br>	elink_remove(&amp;bc-&gt;bufc_used_link);<br>	bc-&gt;bufc_free_link = bufc_free;<br>	bufc_free = bc;<br>	bc-&gt;bufc_addr = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><span class="hljs-comment">// 驱逐一些缓存块</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <br><span class="hljs-title function_">bufc_evict</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>{<br>	<span class="hljs-type">int</span> r;<br><br>	EmbedLink *ln;<br>	<span class="hljs-comment">// 驱逐所有Access位为0的块</span><br>	<span class="hljs-keyword">for</span> (ln = bufc_used.next; ln != &amp;bufc_used;) {<br>		BufferCache *bc = master(ln, BufferCache, bufc_used_link);<br>		<span class="hljs-type">void</span> *addr = bc-&gt;bufc_addr;<br>		ln = ln-&gt;next;<br>		<span class="hljs-keyword">if</span> (!(uvpt[PGNUM(addr)] &amp; PTE_A)) {<br>			<span class="hljs-keyword">if</span> (r = bufc_remove(bc), r &lt; <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">return</span> r;<br>		}<br>	}<br>	<span class="hljs-comment">// 如果失败，则驱逐最早进入缓存的块</span><br>	<span class="hljs-keyword">if</span> (ncache == NCACHE) {<br>		ln = bufc_used.next;<br>		assert(ln != &amp;bufc_used);<br>		BufferCache *bc = master(ln, BufferCache, bufc_used_link);<br>		<span class="hljs-keyword">if</span> (r = bufc_remove(bc), r &lt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> r;<br>	}<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<p>顺便在<code>free_block</code>时也将其映射的页释放：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Mark a block free in the bitmap</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">free_block</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> blockno)</span><br>{<br>	<span class="hljs-type">int</span> r;<br>	<span class="hljs-comment">// Blockno zero is the null pointer of block numbers.</span><br>	<span class="hljs-keyword">if</span> (blockno == <span class="hljs-number">0</span>)<br>		panic(<span class="hljs-string">"attempt to free zero block"</span>);<br>	bitmap[blockno/<span class="hljs-number">32</span>] |= <span class="hljs-number">1</span>&lt;&lt;(blockno%<span class="hljs-number">32</span>);<br>	<span class="hljs-comment">// 释放缓存</span><br>	<span class="hljs-keyword">if</span> (r = sys_page_unmap(<span class="hljs-number">0</span>, diskaddr(blockno)), r &lt; <span class="hljs-number">0</span>)<br>		panic(<span class="hljs-string">"free_block: %e"</span>, r);<br>}<br></code></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>将<code>NCACHE</code>设为16（基本上可以保证肯定会有驱逐现象）后的测试结果，</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs text">internal FS tests [fs/test.c]: OK (1.4s) <br>  fs i/o: OK <br>  check_bc: OK <br>  check_super: OK <br>  check_bitmap: OK <br>  alloc_block: OK <br>  file_open: OK <br>  file_get_block: OK <br>  file_flush/file_truncate/file rewrite: OK <br>testfile: OK (1.1s) <br>  serve_open/file_stat/file_close: OK <br>  file_read: OK <br>  file_write: OK <br>  file_read after file_write: OK <br>  open: OK <br>  large file: OK <br>spawn via spawnhello: OK (1.7s) <br>    (Old jos.out.spawn failure log removed)<br>Protection I/O space: OK (1.0s) <br>PTE_SHARE [testpteshare]: OK (1.8s) <br>    (Old jos.out.pte_share failure log removed)<br>PTE_SHARE [testfdsharing]: OK (2.2s) <br>start the shell [icode]: Timeout! OK (31.8s) <br>testshell: OK (1.9s) <br>primespipe: OK (5.5s) <br>Score: 150/150<br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2020/10/05/MIT%206.828%20JOS%20Lab4%20%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">← Next MIT 6.828 JOS Lab4 实验报告</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2020/10/05/MIT%206.828%20JOS%20Lab3%20%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">MIT 6.828 JOS Lab3 实验报告 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a target="_blank" rel="noopener" href="https://prts.wiki/w/%E6%96%87%E4%BB%B6:%E6%A8%A1%E7%BB%84_%E5%8C%BB%E4%B8%8D%E8%87%AA%E6%B2%BB.png" id="logo"><img src="/imgs/avatar.png" alt="Logo"></a><h1 id="Dr"><a href="/">Renze Chen</a></h1><div id="description"><p>陈仁泽</p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/Light-of-Hers"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://www.zhihu.com/people/yi-guang-99-48"><i class="fab fa-zhihu" alt="Zhihu"></i></a><a class="social" target="_blank" rel="noopener" href="https://orcid.org/0000-0001-5938-7965"><i class="fab fa-orcid" alt="ORCID"></i></a><a class="social" target="_blank" rel="noopener" href="https://dblp.org/pid/260/5910"><i class="iconfont icon-dblp" alt="DBLP"></i></a><a class="social" href="mailto:crz@pku.edu.cn"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-1"><span class="toc-number">2.</span> <span class="toc-text">Exercise 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-2"><span class="toc-number">3.</span> <span class="toc-text">Exercise 2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bc-pgfault"><span class="toc-number">3.1.</span> <span class="toc-text">bc_pgfault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flush-block"><span class="toc-number">3.2.</span> <span class="toc-text">flush_block</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-3"><span class="toc-number">4.</span> <span class="toc-text">Exercise 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-4"><span class="toc-number">5.</span> <span class="toc-text">Exercise 4</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#file-block-walk"><span class="toc-number">5.1.</span> <span class="toc-text">file_block_walk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-get-block"><span class="toc-number">5.2.</span> <span class="toc-text">file_get_block</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-5"><span class="toc-number">6.</span> <span class="toc-text">Exercise 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-6"><span class="toc-number">7.</span> <span class="toc-text">Exercise 6</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#serve-write"><span class="toc-number">7.1.</span> <span class="toc-text">serve_write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#devfile-write"><span class="toc-number">7.2.</span> <span class="toc-text">devfile_write</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-7"><span class="toc-number">8.</span> <span class="toc-text">Exercise 7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-8"><span class="toc-number">9.</span> <span class="toc-text">Exercise 8</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#duppage"><span class="toc-number">9.1.</span> <span class="toc-text">duppage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy-shared-pages"><span class="toc-number">9.2.</span> <span class="toc-text">copy_shared_pages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-9"><span class="toc-number">10.</span> <span class="toc-text">Exercise 9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-10"><span class="toc-number">11.</span> <span class="toc-text">Exercise 10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#This-completes-this-lab"><span class="toc-number">12.</span> <span class="toc-text">This completes this lab</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge-Disk-Buffer-Cache"><span class="toc-number">13.</span> <span class="toc-text">Challenge: Disk Buffer Cache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E7%9A%84"><span class="toc-number">13.1.</span> <span class="toc-text">目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">13.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">13.3.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">13.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main></body></html>
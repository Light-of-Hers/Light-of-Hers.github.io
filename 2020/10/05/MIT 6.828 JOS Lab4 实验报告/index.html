<!DOCTYPE html><html lang="en" theme-mode="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>MIT 6.828 JOS Lab4 实验报告 | Renze Chen (陈仁泽)</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
@font-face {
  font-family: 'Fira Code';
  src: local('Fira Code'), url('/font/FiraCode-Regular.ttf');
}
@font-face {
  font-family: 'Monaco';
  src: local('Monaco'), url('/font/Monaco.ttf');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/imgs/bk-dark-0.png');
 --light-background: url('/imgs/bk-light-5.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">About</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Blogs</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>MIT 6.828 JOS Lab4 实验报告</h1><div id="post-info"><span>Post Date: <div class="control"><time datetime="2020-10-05T01:48:00.000Z" id="date"> 2020-10-05</time></div></span><br><span>Blog Link: <div class="control"> <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/261880376">[site]</a></div></span></div></div><hr><div id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此为本人上本校的操作系统实习(实验班)时所写的实验报告，简单记述了JOS Lab的各个Exercise、Challenge(未覆盖所有Challenge，每个Lab大概做了1~3个Challenge)的基本思路。仅供有需者参考，上有关课程(比如本校的操统实习实验班)的最好不要直接抄。</p>
<p>附上源代码链接：<a href="https://link.zhihu.com/?target=https://github.com/Light-of-Hers/mit-jos">https://github.com/Light-of-Hers/mit-jos</a></p>
<h2 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h2><p>调用<code>boot_map_region</code>即可，注意需要检查范围是否超过<code>MMIOLIM</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> *<br><span class="hljs-title function_">mmio_map_region</span><span class="hljs-params">(<span class="hljs-type">physaddr_t</span> pa, <span class="hljs-type">size_t</span> size)</span><br>{<br>    <span class="hljs-type">static</span> <span class="hljs-type">uintptr_t</span> base = MMIOBASE;<br><br>    <span class="hljs-type">uintptr_t</span> start;<br>    <br>    start = base;<br>    size = ROUNDUP(size, PGSIZE);<br>	<span class="hljs-keyword">if</span> (base + size &gt; MMIOLIM)<br>		panic(<span class="hljs-string">"overflow MMIOLIM"</span>);<br>    base += size;<br>    boot_map_region(kern_pgdir, start, size, pa, PTE_W | PTE_PCD | PTE_PWT);<br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)start;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h2><p>在<code>page_init</code>里不将<code>MPENTRY_PADDR</code>加入空闲链表即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">page_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MARK_FREE(_i) do {\</span><br><span class="hljs-meta">    size_t __tmp__ = _i;\</span><br><span class="hljs-meta">    pages[__tmp__].pp_ref = 0;\</span><br><span class="hljs-meta">    pages[__tmp__].pp_link = page_free_list;\</span><br><span class="hljs-meta">	page_free_list = &amp;pages[__tmp__];\</span><br><span class="hljs-meta">} while(0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MARK_USE(_i) do {\</span><br><span class="hljs-meta">    size_t __tmp__ = _i;\</span><br><span class="hljs-meta">    pages[__tmp__].pp_ref = 0;\</span><br><span class="hljs-meta">    pages[__tmp__].pp_link = NULL;\</span><br><span class="hljs-meta">} while(0)</span><br><br>    <span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> end[];<br>    <span class="hljs-type">physaddr_t</span> bss_end;<br>    <span class="hljs-type">physaddr_t</span> boot_alloc_end;<br>    <span class="hljs-type">size_t</span> i;<br><br>    page_free_list = <span class="hljs-literal">NULL</span>;<br>    bss_end = PADDR(ROUNDUP((<span class="hljs-type">char</span>*)end, PGSIZE));<br>    boot_alloc_end = PADDR(boot_alloc(<span class="hljs-number">0</span>));<br><br>    MARK_USE(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// --- 添加的内容 ---</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; MPENTRY_PADDR / PGSIZE; ++i)<br>        MARK_FREE(i);<br>    MARK_USE(i++);<br>    <span class="hljs-comment">// -----------------</span><br>    <span class="hljs-keyword">for</span> (; i &lt; npages_basemem; ++i)<br>        MARK_FREE(i);<br>    <span class="hljs-keyword">for</span> (; i &lt; EXTPHYSMEM / PGSIZE; ++i)<br>        MARK_USE(i);<br>    <span class="hljs-keyword">for</span> (; i &lt; bss_end / PGSIZE; ++i)<br>        MARK_USE(i);<br>    <span class="hljs-keyword">for</span> (; i &lt; boot_alloc_end / PGSIZE; ++i)<br>        MARK_USE(i);<br>    <span class="hljs-keyword">for</span> (; i &lt; npages; ++i)<br>        MARK_FREE(i);<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> MARK_USE</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> MARK_FREE</span><br>}<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Q: Compare kern/mpentry.S side by side with boot/boot.S. Bearing in mind that kern/mpentry.S is compiled and linked to run above KERNBASE just like everything else in the kernel, what is the purpose of macro MPBOOTPHYS? Why is it necessary in kern/mpentry.S but not in boot/boot.S? In other words, what could go wrong if it were omitted in kern/mpentry.S? Hint: recall the differences between the link address and the load address that we have discussed in Lab 1.</p>
<p>A:</p>
<ol>
<li>计算出符号的物理地址。</li>
<li>该代码段在编译链接时所重定位的位置不在<code>MPENTRY_PADDR</code>这块。实际运行时将这段代码拷贝到<code>MPENTRY_PADDR</code>再运行AP。因此对于需要绝对寻址的代码，要用<code>MPBOOTPHYS</code>来修改地址。而<code>boot.S</code>就没有这个需求。</li>
</ol>
</blockquote>
<h2 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h2><p>直接用<code>boot_map_region</code>分配就行了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">mem_init_mp</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; NCPU; ++i) {<br>        boot_map_region(<br>            kern_pgdir, <br>            KSTACKTOP - KSTKSIZE - i * (KSTKSIZE + KSTKGAP),<br>            KSTKSIZE,<br>            PADDR(percpu_kstacks[i]),<br>            PTE_W <br>        );<br>    }<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h2><p>先获取当前的CPU号，再初始化TS的ESP,SS等部分，初始化GDT中的TSS项，最后加载TSS选择子和IDT。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">trap_init_percpu</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Taskstate</span> *<span class="hljs-title">ts</span>;</span><br>    <span class="hljs-type">size_t</span> i;<br><br>    i = cpunum();<br>    ts = &amp;cpus[i].cpu_ts;<br>    ts-&gt;ts_esp0 = (<span class="hljs-type">uintptr_t</span>)percpu_kstacks[i] + KSTKSIZE;<br>    ts-&gt;ts_ss0 = GD_KD;<br>    ts-&gt;ts_iomb = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Taskstate);<br><br>    gdt[(GD_TSS0 &gt;&gt; <span class="hljs-number">3</span>) + i] = SEG16(STS_T32A, (<span class="hljs-type">uint32_t</span>)ts, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Taskstate) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    gdt[(GD_TSS0 &gt;&gt; <span class="hljs-number">3</span>) + i].sd_s = <span class="hljs-number">0</span>;<br><br>    ltr(GD_TSS0 + (i &lt;&lt; <span class="hljs-number">3</span>));<br><br>    lidt(&amp;idt_pd);<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h2><p>在<code>kern/init.c</code>的<code>i386_init</code>中加锁：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Lab 4 multitasking initialization functions</span><br>pic_init();<br><br><span class="hljs-comment">// Acquire the big kernel lock before waking up APs</span><br><span class="hljs-comment">// Your code here:</span><br>lock_kernel();<br><br><span class="hljs-comment">// Starting non-boot CPUs</span><br>boot_aps();<br></code></pre></td></tr></table></figure>

<p>在<code>kern/init.c</code>的<code>mp_main</code>中加锁：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Now that we have finished some basic setup, call sched_yield()</span><br><span class="hljs-comment">// to start running processes on this CPU.  But make sure that</span><br><span class="hljs-comment">// only one CPU can enter the scheduler at a time!</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Your code here:</span><br>lock_kernel();<br><br>sched_yield();<br></code></pre></td></tr></table></figure>

<p>在<code>kern/trap.c</code>的<code>trap</code>中加锁：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="hljs-number">3</span>) == <span class="hljs-number">3</span>) {<br>    <span class="hljs-comment">// Trapped from user mode.</span><br>    <span class="hljs-comment">// Acquire the big kernel lock before doing any</span><br>    <span class="hljs-comment">// serious kernel work.</span><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    lock_kernel();<br></code></pre></td></tr></table></figure>

<p>在<code>kern/env.c</code>的<code>env_run</code>中解锁：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">unlock_kernel();<br>env_pop_tf(&amp;e-&gt;env_tf);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Q: It seems that using the big kernel lock guarantees that only one CPU can run the kernel code at a time. Why do we still need separate kernel stacks for each CPU? Describe a scenario in which using a shared kernel stack will go wrong, even with the protection of the big kernel lock.</p>
<p>A: 内核锁的获取是在陷入内核之后进行的，这样的话在抢夺内核锁之前，内核栈上至少已经压入了CS和EIP等硬件压入的上下文。如果共享内核栈的话，在多个CPU同时陷入内核时，就会造成内核栈上保存的内容不一致。</p>
</blockquote>
<h2 id="Exercise-6"><a href="#Exercise-6" class="headerlink" title="Exercise 6"></a>Exercise 6</h2><p>按要求实现即可，因为有内核锁，所以完全不用考虑竞争的问题(^_^)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">sched_yield</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">idle</span>;</span><br>    <br>    idle = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> (curenv) {<br>        <span class="hljs-type">size_t</span> eidx = ENVX(curenv-&gt;env_id);<br>        <span class="hljs-type">uint32_t</span> mask = NENV - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = (eidx + <span class="hljs-number">1</span>) &amp; mask; i != eidx; i = (i + <span class="hljs-number">1</span>) &amp; mask) {<br>            <span class="hljs-keyword">if</span> (envs[i].env_status == ENV_RUNNABLE) {<br>                idle = &amp;envs[i];<br>                <span class="hljs-keyword">break</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">if</span> (!idle &amp;&amp; curenv-&gt;env_status == ENV_RUNNING)<br>            idle = curenv;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; NENV; ++i) {<br>            <span class="hljs-keyword">if</span> (envs[i].env_status == ENV_RUNNABLE) {<br>                idle = &amp;envs[i];<br>                <span class="hljs-keyword">break</span>;<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">if</span> (idle)<br>        env_run(idle);<br>    <span class="hljs-comment">// sched_halt never returns</span><br>    sched_halt();<br>}<br></code></pre></td></tr></table></figure>

<p>对syscall等的修改比较简单，就不列出了</p>
<blockquote>
<p>Q: In your implementation of env_run() you should have called lcr3(). Before and after the call to lcr3(), your code makes references (at least it should) to the variable e, the argument to env_run. Upon loading the %cr3 register, the addressing context used by the MMU is instantly changed. But a virtual address (namely e) has meaning relative to a given address context–the address context specifies the physical address to which the virtual address maps. Why can the pointer e be dereferenced both before and after the addressing switch?</p>
<p>A: 因为所有进程的地址空间在内核部分的映射都是一样的。</p>
</blockquote>
<blockquote>
<p>Q: Whenever the kernel switches from one environment to another, it must ensure the old environment’s registers are saved so they can be restored properly later. Why? Where does this happen?</p>
<p>A: 因为进程没有自己单独的内核栈，因此寄存器上下文必须保存在PCB之类的结构中，以便之后恢复上下文。在<code>trap.c</code>的<code>trap</code>内保存寄存器上下文：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Copy trap frame (which is currently on the stack)</span><br><span class="hljs-comment">// into 'curenv-&gt;env_tf', so that running the environment</span><br><span class="hljs-comment">// will restart at the trap point.</span><br>curenv-&gt;env_tf = *tf;<br><span class="hljs-comment">// The trapframe on the stack should be ignored from here on.</span><br>tf = &amp;curenv-&gt;env_tf;<br></code></pre></td></tr></table></figure>
</blockquote>
<h2 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h2><h3 id="sys-exofork"><a href="#sys-exofork" class="headerlink" title="sys_exofork"></a><code>sys_exofork</code></h3><p>按要求实现即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">envid_t</span><br><span class="hljs-title function_">sys_exofork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">parent</span>, *<span class="hljs-title">child</span>;</span><br>    <br>    parent = curenv;<br>    <span class="hljs-keyword">if</span> (r= env_alloc(&amp;child, parent-&gt;env_id), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br><br>    child-&gt;env_status = ENV_NOT_RUNNABLE;<br>    child-&gt;env_tf = parent-&gt;env_tf;<br>    child-&gt;env_tf.tf_regs.reg_eax = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">return</span> child-&gt;env_id;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="sys-env-set-status"><a href="#sys-env-set-status" class="headerlink" title="sys_env_set_status"></a><code>sys_env_set_status</code></h3><p>需要检查<code>status</code>是合法的，并且<code>envid2env</code>也要检查合法性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_env_set_status</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">int</span> status)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">e</span>;</span><br><br>    <span class="hljs-keyword">if</span> (status &lt; <span class="hljs-number">0</span> || status &gt; ENV_NOT_RUNNABLE)<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;e, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br><br>    e-&gt;env_status = status;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="sys-page-alloc"><a href="#sys-page-alloc" class="headerlink" title="sys_page_alloc"></a><code>sys_page_alloc</code></h3><p>注意需要检查地址的合法性和对齐性，以及<code>perm</code>的合法性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_page_alloc</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">void</span> *va, <span class="hljs-type">int</span> perm)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_ALIGIN_UVA(_va) do {\</span><br><span class="hljs-meta">    uintptr_t __tmp__ = (uintptr_t)(_va);\</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__tmp__ &gt;= UTOP || (__tmp__ &amp; (PGSIZE - 1)))\</span><br><span class="hljs-meta">        return -E_INVAL;\</span><br><span class="hljs-meta">} while (0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK_SYSCALL_PERM(_perm) do {\</span><br><span class="hljs-meta">    int __tmp__ = _perm;\</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (!(__tmp__ &amp; PTE_P) || !(__tmp__ &amp; PTE_U) || (__tmp__ &amp; ~PTE_SYSCALL))\</span><br><span class="hljs-meta">        return -E_INVAL;\</span><br><span class="hljs-meta">} while (0)</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">e</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pp</span>;</span><br><br>    CHECK_ALIGIN_UVA(va);<br>    CHECK_SYSCALL_PERM(perm);<br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;e, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (!(pp = page_alloc(ALLOC_ZERO)))<br>        <span class="hljs-keyword">return</span> -E_NO_MEM;<br>    <span class="hljs-keyword">if</span> (r = page_insert(e-&gt;env_pgdir, pp, va, perm), r &lt; <span class="hljs-number">0</span>) {<br>        page_free(pp);<br>        <span class="hljs-keyword">return</span> r;<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="sys-page-map"><a href="#sys-page-map" class="headerlink" title="sys_page_map"></a><code>sys_page_map</code></h3><p>过程较为繁琐，需要进行多个检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_page_map</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> srcenvid, <span class="hljs-type">void</span> *srcva,</span><br><span class="hljs-params">	     <span class="hljs-type">envid_t</span> dstenvid, <span class="hljs-type">void</span> *dstva, <span class="hljs-type">int</span> perm)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">srce</span>, *<span class="hljs-title">dste</span>;</span><br>    <span class="hljs-type">pte_t</span> *pte;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pp</span>;</span><br><br>    CHECK_ALIGIN_UVA(srcva);<br>    CHECK_ALIGIN_UVA(dstva);<br>    CHECK_SYSCALL_PERM(perm);<br>    <span class="hljs-keyword">if</span> (r = envid2env(srcenvid, &amp;srce, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (r = envid2env(dstenvid, &amp;dste, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (!(pp = page_lookup(srce-&gt;env_pgdir, srcva, &amp;pte)))<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br>    <span class="hljs-keyword">if</span> (!(*pte | PTE_W) &amp;&amp; (perm &amp; PTE_W))<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br>    <span class="hljs-keyword">if</span> (r = page_insert(dste-&gt;env_pgdir, pp, dstva, perm), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="sys-page-unmap"><a href="#sys-page-unmap" class="headerlink" title="sys_page_unmap"></a><code>sys_page_unmap</code></h3><p>比较简单，用<code>page_remove</code>即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_page_unmap</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">void</span> *va)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">e</span>;</span><br><br>    CHECK_ALIGIN_UVA(va);<br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;e, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    page_remove(e-&gt;env_pgdir, va);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> CHECK_SYSCALL_PERM</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> CHECK_ALIGIN_UVA</span><br></code></pre></td></tr></table></figure>

<h2 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h2><p><code>envid2env</code>需要检查进程访问权限，其他按要求实现即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_env_set_pgfault_upcall</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">void</span> *func)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">e</span>;</span><br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;e, <span class="hljs-number">1</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    e-&gt;env_pgfault_upcall = func;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h2><p>过程较为繁琐，具体过程见注释：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">page_fault_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>{<br>    <span class="hljs-type">uint32_t</span> fault_va;<br><br>    <span class="hljs-comment">// Read processor's CR2 register to find the faulting address</span><br>    fault_va = rcr2();<br><br>    <span class="hljs-comment">// Handle kernel-mode page faults.</span><br><br>    <span class="hljs-comment">// LAB 3: Your code here.</span><br>    <span class="hljs-keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) {<br>        print_trapframe(tf);<br>        panic(<span class="hljs-string">"[%08x] kernel fault va %08x ip %08x\n"</span>,<br>		    curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);<br>    }<br><br>    <span class="hljs-comment">// check upcall</span><br>    <span class="hljs-keyword">if</span> (!curenv-&gt;env_pgfault_upcall) {<br>        <span class="hljs-built_in">log</span>(<span class="hljs-string">"no upcall"</span>);<br>        <span class="hljs-keyword">goto</span> bad;<br>    }<br>    <span class="hljs-comment">// check whether upcall and xstack are in user space</span><br>    user_mem_assert(curenv, (<span class="hljs-type">void</span>*)curenv-&gt;env_pgfault_upcall, <span class="hljs-number">0</span>, PTE_U);<br>    user_mem_assert(curenv, (<span class="hljs-type">void</span>*)(UXSTACKTOP - <span class="hljs-number">1</span>), <span class="hljs-number">0</span>, PTE_U | PTE_W);<br>    <span class="hljs-comment">// check xstack overflow</span><br>    <span class="hljs-keyword">if</span> (fault_va &lt; UXSTACKTOP - PGSIZE &amp;&amp; fault_va &gt;= UXSTACKTOP - <span class="hljs-number">2</span> * PGSIZE) {<br>        <span class="hljs-built_in">log</span>(<span class="hljs-string">"xstack overflow"</span>);<br>        <span class="hljs-keyword">goto</span> bad;<br>    }<br><br>    <span class="hljs-comment">// prepare stack frame</span><br>    <span class="hljs-type">uint32_t</span> esp;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">UTrapframe</span>* <span class="hljs-title">utf</span>;</span><br><br>    <span class="hljs-keyword">if</span> (tf-&gt;tf_esp &gt;= UXSTACKTOP - PGSIZE &amp;&amp; tf-&gt;tf_esp &lt;= UXSTACKTOP) {<br>        esp = tf-&gt;tf_esp - (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> UTrapframe) + <span class="hljs-number">4</span>);<br>    } <span class="hljs-keyword">else</span> {<br>        esp = UXSTACKTOP - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> UTrapframe);<br>    }<br>    <span class="hljs-comment">// stack overflow</span><br>    <span class="hljs-keyword">if</span> (esp &lt; UXSTACKTOP - PGSIZE) {<br>        <span class="hljs-built_in">log</span>(<span class="hljs-string">"xstack overflow"</span>);<br>        <span class="hljs-keyword">goto</span> bad;<br>    }<br>    <br>    utf = (<span class="hljs-keyword">struct</span> UTrapframe *) esp;<br>    utf-&gt;utf_eflags = tf-&gt;tf_eflags;<br>    utf-&gt;utf_eip = tf-&gt;tf_eip;<br>    utf-&gt;utf_esp = tf-&gt;tf_esp;<br>    utf-&gt;utf_regs = tf-&gt;tf_regs;<br>    utf-&gt;utf_err = tf-&gt;tf_err;<br>    utf-&gt;utf_fault_va = fault_va;<br><br>    <span class="hljs-comment">// change esp / eip</span><br>    tf-&gt;tf_esp = esp;<br>    tf-&gt;tf_eip = (<span class="hljs-type">uint32_t</span>)curenv-&gt;env_pgfault_upcall;<br>    <span class="hljs-keyword">return</span>;<br><br>bad:<br>    <span class="hljs-comment">// Destroy the environment that caused the fault.</span><br>    cprintf(<span class="hljs-string">"[%08x] user fault va %08x ip %08x\n"</span>,<br>        curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);<br>    print_trapframe(tf);<br>    env_destroy(curenv);<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-10"><a href="#Exercise-10" class="headerlink" title="Exercise 10"></a>Exercise 10</h2><p>首先需要将返回地址压到“将要切换回去的栈”，接着依次恢复寄存器即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs C">.text<br>.globl _pgfault_upcall<br>_pgfault_upcall:<br>    <span class="hljs-comment">// Call the C page fault handler.</span><br>    pushl %esp			<span class="hljs-comment">// function argument: pointer to UTF</span><br>    movl _pgfault_handler, %eax<br>    call *%eax<br>    addl $<span class="hljs-number">4</span>, %esp			<span class="hljs-comment">// pop function argument</span><br><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    movl <span class="hljs-number">48</span>(%esp), %eax<br>    movl <span class="hljs-number">40</span>(%esp), %ebx<br>    subl $<span class="hljs-number">4</span>, %eax<br>    movl %ebx, (%eax)<br>    movl %eax, <span class="hljs-number">48</span>(%esp)<br><br>    <span class="hljs-comment">// Restore the trap-time registers.  After you do this, you</span><br>    <span class="hljs-comment">// can no longer modify any general-purpose registers.</span><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    addl $<span class="hljs-number">8</span>, %esp<br>    popal<br><br>    <span class="hljs-comment">// Restore eflags from the stack.  After you do this, you can</span><br>    <span class="hljs-comment">// no longer use arithmetic operations or anything else that</span><br>    <span class="hljs-comment">// modifies eflags.</span><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    addl $<span class="hljs-number">4</span>, %esp <br>    popf<br><br>    <span class="hljs-comment">// Switch back to the adjusted trap-time stack.</span><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    movl (%esp), %esp<br><br>    <span class="hljs-comment">// Return to re-execute the instruction that faulted.</span><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    ret<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-11"><a href="#Exercise-11" class="headerlink" title="Exercise 11"></a>Exercise 11</h2><p>分配一个异常处理栈，再设置upcall函数即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">set_pgfault_handler</span><span class="hljs-params">(<span class="hljs-type">void</span> (*handler)(<span class="hljs-keyword">struct</span> UTrapframe *utf))</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PANIC panic(<span class="hljs-string">"set_pgfault_handler: %e"</span>, r)</span><br><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-keyword">if</span> (_pgfault_handler == <span class="hljs-number">0</span>) {<br>        <span class="hljs-comment">// First time through!</span><br>        <span class="hljs-comment">// LAB 4: Your code here.</span><br>        <span class="hljs-comment">// panic("set_pgfault_handler not implemented");</span><br>        <br>        <span class="hljs-keyword">if</span> (r = sys_page_alloc(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span>*)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W), r &lt; <span class="hljs-number">0</span>)<br>            PANIC;<br>        <span class="hljs-keyword">if</span> (r = sys_env_set_pgfault_upcall(<span class="hljs-number">0</span>, _pgfault_upcall), r &lt; <span class="hljs-number">0</span>)<br>            PANIC;<br>    }<br><br>    <span class="hljs-comment">// Save handler pointer for assembly to call.</span><br>    _pgfault_handler = handler;<br>    <span class="hljs-keyword">return</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> PANIC</span><br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-12"><a href="#Exercise-12" class="headerlink" title="Exercise 12"></a>Exercise 12</h2><h3 id="fork"><a href="#fork" class="headerlink" title="fork"></a><code>fork</code></h3><p>先<code>exofork</code>一个进程，之后父进程将用户空间用<code>duppage</code>拷贝过去，再单独分配一个异常栈，设置upcall，最后再设置子进程的状态：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">envid_t</span><br><span class="hljs-title function_">fork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PANIC panic(<span class="hljs-string">"fork: %e"</span>, r)</span><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("fork not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">envid_t</span> ceid;<br><br>    set_pgfault_handler(pgfault);<br><br>    <span class="hljs-keyword">if</span> (ceid = sys_exofork(), ceid == <span class="hljs-number">0</span>) {<br>        thisenv = &amp;envs[ENVX(sys_getenvid())];<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ceid &gt; <span class="hljs-number">0</span>) {<br>        <span class="hljs-comment">// assume UTOP == UXSTACKTOP</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> pn = <span class="hljs-number">0</span>; pn &lt; UTOP / PGSIZE - <span class="hljs-number">1</span>;) {<br>            <span class="hljs-type">uint32_t</span> pde = uvpd[pn / NPDENTRIES];<br>            <span class="hljs-keyword">if</span> (!(pde &amp; PTE_P)) {<br>                pn += NPDENTRIES;<br>            } <span class="hljs-keyword">else</span> {<br>                <span class="hljs-type">size_t</span> next = MIN(UTOP / PGSIZE - <span class="hljs-number">1</span>, pn + NPDENTRIES);<br>                <span class="hljs-keyword">for</span> (; pn &lt; next; ++pn) {<br>                    <span class="hljs-type">uint32_t</span> pte = uvpt[pn];<br>                    <span class="hljs-keyword">if</span> (pte &amp; PTE_P &amp;&amp; pte &amp; PTE_U)<br>                        <span class="hljs-keyword">if</span> (r = duppage(ceid, pn), r &lt; <span class="hljs-number">0</span>)<br>                            PANIC;<br>                }<br>            }<br>        }<br>        <span class="hljs-keyword">if</span> (r = sys_page_alloc(ceid, (<span class="hljs-type">void</span>*)(UXSTACKTOP - PGSIZE), <br>                                PTE_P | PTE_U | PTE_W), r &lt; <span class="hljs-number">0</span>)<br>            PANIC;<br>        <span class="hljs-keyword">if</span> (r = sys_env_set_pgfault_upcall(ceid, _pgfault_upcall), r &lt; <span class="hljs-number">0</span>)<br>            PANIC;<br>        <span class="hljs-keyword">if</span> (r = sys_env_set_status(ceid, ENV_RUNNABLE), r &lt; <span class="hljs-number">0</span>)<br>            PANIC;<br>    }<br>    <span class="hljs-keyword">return</span> ceid;<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> PANIC</span><br>}<br></code></pre></td></tr></table></figure>

<h3 id="duppage"><a href="#duppage" class="headerlink" title="duppage"></a><code>duppage</code></h3><p>按要求拷贝页面即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">duppage</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">unsigned</span> pn)</span><br>{<br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("duppage not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">void</span> *pg;<br>    <span class="hljs-type">pte_t</span> pte;<br><br>    pg = (<span class="hljs-type">void</span>*)(pn * PGSIZE);<br>    pte = uvpt[pn];<br><br>    assert(pte &amp; PTE_P &amp;&amp; pte &amp; PTE_U);<br>    <span class="hljs-keyword">if</span> (pte &amp; PTE_W || pte &amp; PTE_COW) {<br>        <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, pg, envid, pg, PTE_P | PTE_U | PTE_COW), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>        <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, pg, <span class="hljs-number">0</span>, pg, PTE_P | PTE_U | PTE_COW), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, pg, envid, pg, PTE_P | PTE_U), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>    }<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="pgfault"><a href="#pgfault" class="headerlink" title="pgfault"></a><code>pgfault</code></h3><p>过程比较简单，主要是检查出错地址比较繁琐：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">pgfault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> UTrapframe *utf)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PANIC panic(<span class="hljs-string">"page fault handler: %e"</span>, r)</span><br><br>    <span class="hljs-type">void</span> *addr = (<span class="hljs-type">void</span> *) utf-&gt;utf_fault_va;<br>    <span class="hljs-type">uint32_t</span> err = utf-&gt;utf_err;<br>    <span class="hljs-type">int</span> r;<br><br>    <span class="hljs-comment">// Check that the faulting access was (1) a write, and (2) to a</span><br>    <span class="hljs-comment">// copy-on-write page.  If not, panic.</span><br>    <span class="hljs-comment">// Hint:</span><br>    <span class="hljs-comment">//   Use the read-only page table mappings at uvpt</span><br>    <span class="hljs-comment">//   (see &lt;inc/memlayout.h&gt;).</span><br><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    addr = ROUNDDOWN(addr, PGSIZE);<br><br>    <span class="hljs-keyword">if</span> (!(<br>            (uvpd[PDX(addr)] &amp; PTE_P) &amp;&amp; <br>            (uvpt[PGNUM(addr)] &amp; PTE_P) &amp;&amp; <br>            (uvpt[PGNUM(addr)] &amp; PTE_U) &amp;&amp; <br>            (uvpt[PGNUM(addr)] &amp; PTE_COW) &amp;&amp; <br>            (err &amp; FEC_WR) &amp;&amp; <br>            <span class="hljs-number">1</span><br>        )) {<br>        panic(<br>            <span class="hljs-string">"[0x%08x] user page fault va 0x%08x ip 0x%08x: "</span><br>            <span class="hljs-string">"[%s, %s, %s]"</span>,<br>            sys_getenvid(),<br>            utf-&gt;utf_fault_va,<br>            utf-&gt;utf_eip,<br>            err &amp; <span class="hljs-number">4</span> ? <span class="hljs-string">"user"</span> : <span class="hljs-string">"kernel"</span>,<br>            err &amp; <span class="hljs-number">2</span> ? <span class="hljs-string">"write"</span> : <span class="hljs-string">"read"</span>,<br>            err &amp; <span class="hljs-number">1</span> ? <span class="hljs-string">"protection"</span> : <span class="hljs-string">"not-present"</span><br>        );<br>    }<br><br>    <span class="hljs-comment">// Allocate a new page, map it at a temporary location (PFTEMP),</span><br>    <span class="hljs-comment">// copy the data from the old page to the new page, then move the new</span><br>    <span class="hljs-comment">// page to the old page's address.</span><br>    <span class="hljs-comment">// Hint:</span><br>    <span class="hljs-comment">//   You should make three system calls.</span><br><br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-keyword">if</span> (r = sys_page_alloc(<span class="hljs-number">0</span>, PFTEMP, PTE_P | PTE_U | PTE_W), r &lt; <span class="hljs-number">0</span>)<br>        PANIC;<br>    memmove(PFTEMP, addr, PGSIZE);<br>    <span class="hljs-keyword">if</span> (r = sys_page_map(<span class="hljs-number">0</span>, PFTEMP, <span class="hljs-number">0</span>, addr, PTE_P | PTE_U | PTE_W), r &lt; <span class="hljs-number">0</span>)<br>        PANIC;<br>    <span class="hljs-keyword">if</span> (r = sys_page_unmap(<span class="hljs-number">0</span>, PFTEMP), r &lt; <span class="hljs-number">0</span>)<br>        PANIC;<br>    <span class="hljs-keyword">return</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> PANIC</span><br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-13"><a href="#Exercise-13" class="headerlink" title="Exercise 13"></a>Exercise 13</h2><p>对我来说只需要在<code>kern/trapentry.inc</code>里添加几项即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C">TH(<span class="hljs-number">32</span>) <span class="hljs-comment">// TIMER</span><br>TH(<span class="hljs-number">33</span>) <span class="hljs-comment">// KBD</span><br>TH(<span class="hljs-number">36</span>) <span class="hljs-comment">// SERIAL</span><br>TH(<span class="hljs-number">39</span>) <span class="hljs-comment">// SPURIOUS</span><br>TH(<span class="hljs-number">46</span>) <span class="hljs-comment">// IDE</span><br>TH(<span class="hljs-number">51</span>) <span class="hljs-comment">// ERROR</span><br></code></pre></td></tr></table></figure>

<p>在<code>kern/env.c</code>的<code>env_alloc</code>里加入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Enable interrupts while in user mode.</span><br><span class="hljs-comment">// LAB 4: Your code here.</span><br>e-&gt;env_tf.tf_eflags |= FL_IF;<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-14"><a href="#Exercise-14" class="headerlink" title="Exercise 14"></a>Exercise 14</h2><p>在<code>trap_dispatch</code>中加入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_TIMER) {<br>    lapic_eoi();<br>    sched_yield();<br>    <span class="hljs-keyword">return</span>;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Exercise-15"><a href="#Exercise-15" class="headerlink" title="Exercise 15"></a>Exercise 15</h2><h3 id="kern-syscall-c"><a href="#kern-syscall-c" class="headerlink" title="kern/syscall.c"></a><code>kern/syscall.c</code></h3><p>定义了<code>ipc_try_send</code>和<code>ipc_send_page</code>作为辅助函数，其他实现按要求即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <br><span class="hljs-title function_">ipc_send_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* srce, <span class="hljs-keyword">struct</span> Env* dste)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">void</span> * srcva = srce-&gt;env_ipc_dstva;<br>    <span class="hljs-type">void</span> * dstva = dste-&gt;env_ipc_dstva;<br>    <span class="hljs-type">unsigned</span> perm = srce-&gt;env_ipc_perm;<br>    <span class="hljs-keyword">if</span> (srcva &lt; (<span class="hljs-type">void</span>*)UTOP &amp;&amp; dstva &lt; (<span class="hljs-type">void</span>*)UTOP) {<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pp</span>;</span><br>        <span class="hljs-type">pte_t</span> *pte;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">uint32_t</span>)srcva &amp; (PGSIZE - <span class="hljs-number">1</span>))<br>            <span class="hljs-keyword">return</span> -E_INVAL;<br>        <span class="hljs-keyword">if</span> (!(perm &amp; PTE_P) || !(perm &amp; PTE_U) || perm &amp; ~PTE_SYSCALL)<br>            <span class="hljs-keyword">return</span> -E_INVAL;<br>        <span class="hljs-keyword">if</span> (pp = page_lookup(srce-&gt;env_pgdir, srcva, &amp;pte), !pp)<br>            <span class="hljs-keyword">return</span> -E_INVAL;<br>        <span class="hljs-keyword">if</span> (perm &amp; PTE_W &amp;&amp; !(*pte &amp; PTE_W))<br>            <span class="hljs-keyword">return</span> -E_INVAL;<br>        <span class="hljs-keyword">if</span> (r = page_insert(dste-&gt;env_pgdir, pp, dstva, perm), r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> r;<br>    } <span class="hljs-keyword">else</span> {<br>        dste-&gt;env_ipc_perm = <span class="hljs-number">0</span>;<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <br><span class="hljs-title function_">ipc_try_send</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* dste, <span class="hljs-type">uint32_t</span> value, <span class="hljs-type">void</span>* srcva, <span class="hljs-type">unsigned</span> perm)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">cure</span> =</span> curenv;<br><br>    <span class="hljs-keyword">if</span> (!(dste-&gt;env_ipc_recving &amp;&amp; dste-&gt;env_status == ENV_NOT_RUNNABLE))<br>        <span class="hljs-keyword">return</span> -E_IPC_NOT_RECV;<br><br>    <span class="hljs-comment">// map page</span><br>    cure-&gt;env_ipc_dstva = srcva;<br>    cure-&gt;env_ipc_perm = perm;<br>    <span class="hljs-keyword">if</span> (r = ipc_send_page(cure, dste), r &lt; <span class="hljs-number">0</span>) <br>        <span class="hljs-keyword">return</span> r;<br><br>    <span class="hljs-comment">// ok</span><br>    dste-&gt;env_ipc_recving = <span class="hljs-number">0</span>;<br>    dste-&gt;env_ipc_from = cure-&gt;env_id;<br>    dste-&gt;env_ipc_value = value;<br>    dste-&gt;env_status = ENV_RUNNABLE;<br>    dste-&gt;env_tf.tf_regs.reg_eax = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_ipc_try_send</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">uint32_t</span> value, <span class="hljs-type">void</span> *srcva, <span class="hljs-type">unsigned</span> perm)</span><br>{<br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("sys_ipc_try_send not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">dste</span>;</span><br><br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;dste, <span class="hljs-number">0</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">return</span> ipc_try_send(dste, value, srcva, perm);<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_ipc_recv</span><span class="hljs-params">(<span class="hljs-type">void</span> *dstva)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">cure</span> =</span> curenv;<br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("sys_ipc_recv not implemented");</span><br>    <span class="hljs-keyword">if</span> (dstva &lt; (<span class="hljs-type">void</span>*)UTOP &amp;&amp; (<span class="hljs-type">uint32_t</span>)dstva &amp; (PGSIZE - <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br>    cure-&gt;env_ipc_dstva = dstva;<br>    cure-&gt;env_ipc_recving = <span class="hljs-number">1</span>;<br>    cure-&gt;env_status = ENV_NOT_RUNNABLE;<br>    sched_yield();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h3 id="lib-ipc-c"><a href="#lib-ipc-c" class="headerlink" title="lib/ipc.c"></a><code>lib/ipc.c</code></h3><p>按要求实现即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int32_t</span><br><span class="hljs-title function_">ipc_recv</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> *from_env_store, <span class="hljs-type">void</span> *pg, <span class="hljs-type">int</span> *perm_store)</span><br>{<br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("ipc_recv not implemented");</span><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">envid_t</span> feid;<br>    <span class="hljs-type">int</span> perm;<br><br>    <span class="hljs-keyword">if</span> (r = sys_ipc_recv(pg ? ROUNDDOWN(pg, PGSIZE) : (<span class="hljs-type">void</span>*)UTOP), r &lt; <span class="hljs-number">0</span>) {<br>        feid = <span class="hljs-number">0</span>;<br>        perm = <span class="hljs-number">0</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        feid = thisenv-&gt;env_ipc_from;<br>        perm = thisenv-&gt;env_ipc_perm;<br>    }<br>    <span class="hljs-keyword">if</span> (from_env_store)<br>        *from_env_store = feid;<br>    <span class="hljs-keyword">if</span> (perm_store)<br>        *perm_store = perm;<br>    <span class="hljs-keyword">return</span> r &lt; <span class="hljs-number">0</span> ? r : thisenv-&gt;env_ipc_value;<br>}<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">ipc_send</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> to_env, <span class="hljs-type">uint32_t</span> val, <span class="hljs-type">void</span> *pg, <span class="hljs-type">int</span> perm)</span><br>{<br>    <span class="hljs-comment">// LAB 4: Your code here.</span><br>    <span class="hljs-comment">// panic("ipc_send not implemented");</span><br>    <span class="hljs-type">int</span> r;<br><br>    <span class="hljs-keyword">while</span>(r = sys_ipc_try_send(to_env, val, pg ? <br>                                ROUNDDOWN(pg, PGSIZE) : <br>                                (<span class="hljs-type">void</span>*)UTOP, perm), r == -E_IPC_NOT_RECV)<br>        sys_yield();<br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br>        panic(<span class="hljs-string">"ipc send: %e"</span>, r);<br>}<br></code></pre></td></tr></table></figure>

<h2 id="This-completes-this-lab"><a href="#This-completes-this-lab" class="headerlink" title="This completes this lab"></a>This completes this lab</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs text">dumbfork: OK (0.9s) <br>Part A score: 5/5<br><br>faultread: OK (0.8s) <br>faultwrite: OK (1.2s) <br>faultdie: OK (1.6s) <br>faultregs: OK (2.2s) <br>faultalloc: OK (1.0s) <br>faultallocbad: OK (1.7s) <br>faultnostack: OK (2.2s) <br>faultbadhandler: OK (2.1s) <br>faultevilhandler: OK (1.9s) <br>forktree: OK (1.9s) <br>Part B score: 50/50<br><br>spin: OK (2.1s) <br>stresssched: OK (2.3s) <br>sendpage: OK (1.8s) <br>pingpong: OK (1.8s) <br>primes: OK (3.2s) <br>Part C score: 25/25<br><br>Score: 80/80<br></code></pre></td></tr></table></figure>

<p>注：以下结果为开启了<code>CONF_IPC_SLEEP</code>和<code>CONF_MFQ</code>后的测试结果，故这两个相关的challenge的测试结果之后就不再赘述。从中可以看出部分测试的运行时间改进明显（如<code>stresssched</code>）。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs text">dumbfork: OK (1.3s) <br>Part A score: 5/5<br><br>faultread: OK (0.9s) <br>faultwrite: OK (1.1s) <br>faultdie: OK (1.7s)<br>faultregs: OK (1.5s) <br>faultalloc: OK (1.4s) <br>faultallocbad: OK (1.4s) <br>faultnostack: OK (1.7s) <br>faultbadhandler: OK (2.0s) <br>faultevilhandler: OK (2.3s) <br>forktree: OK (1.6s) <br>Part B score: 50/50<br><br>spin: OK (2.9s) <br>stresssched: OK (1.6s) <br>sendpage: OK (1.7s) <br>pingpong: OK (2.1s) <br>primes: OK (3.0s) <br>Part C score: 25/25<br><br>Score: 80/80<br></code></pre></td></tr></table></figure>

<h2 id="Challenge-Sleep-IPC"><a href="#Challenge-Sleep-IPC" class="headerlink" title="Challenge: Sleep IPC"></a>Challenge: Sleep IPC</h2><h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p>实现了一个新的系统调用<code>sys_ipc_send</code>，若目标进程未处于等待状态，会阻塞。接口与<code>sys_ipc_try_send</code>一致。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul>
<li>若调用<code>sys_ipc_send</code>时目标进程未处于接收状态，则加入目标进程的IPC阻塞队列，并将自己的状态设为阻塞；否则正常发送。</li>
<li>若调用<code>sys_ipc_recv</code>时发现自己的IPC阻塞队列非空，则直接取队首的进程接收；否则阻塞。</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="inc-config-h"><a href="#inc-config-h" class="headerlink" title="inc/config.h"></a><code>inc/config.h</code></h4><p>在config文件（Lab2时自己添加的，用于启动或者关闭一些可选功能）中添加选项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONF_IPC_SLEEP</span><br></code></pre></td></tr></table></figure>

<h4 id="inc-elink-h"><a href="#inc-elink-h" class="headerlink" title="inc/elink.h"></a><code>inc/elink.h</code></h4><p>创建了一个新的头文件，定义了嵌于其他结构体中的通用链表节点<code>EmbedLink</code>以及相关的操作函数（参考自Linux的一些数据结构）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inc/types.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EmbedLink</span> {</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EmbedLink</span> *<span class="hljs-title">prev</span>, *<span class="hljs-title">next</span>;</span><br>} EmbedLink;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <br><span class="hljs-title function_">elink_init</span><span class="hljs-params">(EmbedLink *ln)</span> <br>{<br>    ln-&gt;prev = ln-&gt;next = ln;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> EmbedLink* <br><span class="hljs-title function_">elink_remove</span><span class="hljs-params">(EmbedLink *ln)</span> <br>{<br>    ln-&gt;prev-&gt;next = ln-&gt;next;<br>    ln-&gt;next-&gt;prev = ln-&gt;prev;<br>    elink_init(ln);<br>    <span class="hljs-keyword">return</span> ln;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <br><span class="hljs-title function_">elink_insert</span><span class="hljs-params">(EmbedLink *pos, EmbedLink *ln)</span> <br>{<br>    ln-&gt;prev = pos, ln-&gt;next = pos-&gt;next;<br>    ln-&gt;prev-&gt;next = ln-&gt;next-&gt;prev = ln;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <br><span class="hljs-title function_">elink_empty</span><span class="hljs-params">(EmbedLink * ln)</span> <br>{<br>    <span class="hljs-keyword">if</span> (ln-&gt;prev == ln) {<br>        assert(ln-&gt;next == ln);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    }<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <br><span class="hljs-title function_">elink_enqueue</span><span class="hljs-params">(EmbedLink *que, EmbedLink *ln)</span> <br>{<br>    elink_insert(que-&gt;prev, ln);<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> EmbedLink*<br><span class="hljs-title function_">elink_queue_head</span><span class="hljs-params">(EmbedLink* que)</span><br>{<br>    <span class="hljs-keyword">return</span> que-&gt;next;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> EmbedLink* <br><span class="hljs-title function_">elink_dequeue</span><span class="hljs-params">(EmbedLink* que)</span><br>{<br>    <span class="hljs-keyword">return</span> elink_remove(elink_queue_head(que));<br>}<br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> offset(_t, _m) ((uint32_t)(&amp;((_t*)0)-&gt;_m))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> master(_x, _t, _m) ((_t*)((void*)(_x) - offset(_t, _m)))</span><br></code></pre></td></tr></table></figure>

<h4 id="inc-env-h"><a href="#inc-env-h" class="headerlink" title="inc/env.h"></a><code>inc/env.h</code></h4><p>在<code>struct Env</code>中添加两个成员：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">EmbedLink env_ipc_link;         <span class="hljs-comment">// Embeded link to the blocking queue.</span><br>EmbedLink env_ipc_queue;        <span class="hljs-comment">// Blocking queue.</span><br></code></pre></td></tr></table></figure>

<h4 id="kern-env-c"><a href="#kern-env-c" class="headerlink" title="kern/env.c"></a><code>kern/env.c</code></h4><p>在<code>env_alloc</code>中初始化新增成员：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">elink_init(&amp;e-&gt;env_ipc_link);<br>elink_init(&amp;e-&gt;env_ipc_queue);<br></code></pre></td></tr></table></figure>

<p>在<code>env_free</code>中唤醒阻塞的IPC发送者，并将自己从IPC阻塞队列中取下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// wakeup the sleeping senders</span><br><span class="hljs-keyword">while</span>(!elink_empty(&amp;e-&gt;env_ipc_queue)) {<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">sender</span> =</span> master(elink_dequeue(&amp;e-&gt;env_ipc_queue), <br>                                   <span class="hljs-keyword">struct</span> Env, env_ipc_link);<br>	sender-&gt;env_status = ENV_RUNNABLE;<br>	sender-&gt;env_tf.tf_regs.reg_eax = -E_BAD_ENV;<br>}<br>elink_remove(&amp;e-&gt;env_ipc_link);<br></code></pre></td></tr></table></figure>

<h4 id="kern-syscall-c-1"><a href="#kern-syscall-c-1" class="headerlink" title="kern/syscall.c"></a><code>kern/syscall.c</code></h4><p>添加<code>sys_ipc_send</code>，并修改<code>sys_ipc_recv</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <br><span class="hljs-title function_">sys_ipc_send</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> envid, <span class="hljs-type">uint32_t</span> value, <span class="hljs-type">void</span> *srcva, <span class="hljs-type">unsigned</span> perm)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">dste</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">cure</span> =</span> curenv;<br><br>    <span class="hljs-keyword">if</span> (r = envid2env(envid, &amp;dste, <span class="hljs-number">0</span>), r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> r;<br>    <span class="hljs-keyword">if</span> (r = ipc_try_send(dste, value, srcva, perm), r != -E_IPC_NOT_RECV)<br>        <span class="hljs-keyword">return</span> r;<br><br>    cure-&gt;env_ipc_dstva = srcva;<br>    cure-&gt;env_ipc_perm = perm;<br>    cure-&gt;env_ipc_value = value;<br>    cure-&gt;env_status = ENV_NOT_RUNNABLE;<br><br>    elink_enqueue(&amp;dste-&gt;env_ipc_queue, &amp;cure-&gt;env_ipc_link);<br>    sched_yield();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">sys_ipc_recv</span><span class="hljs-params">(<span class="hljs-type">void</span> *dstva)</span><br>{<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">cure</span> =</span> curenv;<br>  <span class="hljs-comment">// LAB 4: Your code here.</span><br>  <span class="hljs-comment">// panic("sys_ipc_recv not implemented");</span><br>    <span class="hljs-keyword">if</span> (dstva &lt; (<span class="hljs-type">void</span>*)UTOP &amp;&amp; (<span class="hljs-type">uint32_t</span>)dstva &amp; (PGSIZE - <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br><br>    cure-&gt;env_ipc_dstva = dstva;<br>    <span class="hljs-keyword">if</span> (!elink_empty(&amp;cure-&gt;env_ipc_queue)) {<br>        EmbedLink* ln = elink_dequeue(&amp;cure-&gt;env_ipc_queue);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">sender</span> =</span> master(ln, <span class="hljs-keyword">struct</span> Env, env_ipc_link);<br><br>        r = ipc_send_page(sender, cure);<br>            <br>        sender-&gt;env_status = ENV_RUNNABLE;<br>        sender-&gt;env_tf.tf_regs.reg_eax = r;<br><br>        <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> sleep;<br><br>        cure-&gt;env_ipc_from = sender-&gt;env_id;<br>        cure-&gt;env_ipc_value = sender-&gt;env_ipc_value;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br><br>sleep:<br>    cure-&gt;env_ipc_recving = <span class="hljs-number">1</span>;<br>    cure-&gt;env_status = ENV_NOT_RUNNABLE;<br>    sched_yield();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></table></figure>

<h4 id="lib-ipc-h"><a href="#lib-ipc-h" class="headerlink" title="lib/ipc.h"></a><code>lib/ipc.h</code></h4><p>修改<code>ipc_send</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">ipc_send</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> to_env, <span class="hljs-type">uint32_t</span> val, <span class="hljs-type">void</span> *pg, <span class="hljs-type">int</span> perm)</span><br>{<br>  <span class="hljs-comment">// LAB 4: Your code here.</span><br>  <span class="hljs-comment">// panic("ipc_send not implemented");</span><br>    <span class="hljs-type">int</span> r;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONF_IPC_SLEEP</span><br>    <span class="hljs-keyword">while</span>(r = sys_ipc_try_send(to_env, val, pg ? <br>                               ROUNDDOWN(pg, PGSIZE) : <br>                               (<span class="hljs-type">void</span>*)UTOP, perm), r == -E_IPC_NOT_RECV)<br>        sys_yield();<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    r = sys_ipc_send(to_env, val, pg ? ROUNDDOWN(pg, PGSIZE) : (<span class="hljs-type">void</span>*)UTOP, perm);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br>        panic(<span class="hljs-string">"ipc send: %e"</span>, r);<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Challenge-Multilevel-Feedback-Queue"><a href="#Challenge-Multilevel-Feedback-Queue" class="headerlink" title="Challenge: Multilevel Feedback Queue"></a>Challenge: Multilevel Feedback Queue</h2><p>实现了多级反馈队列（MFQ）调度算法。</p>
<p>原理不再赘述，下面仅说明实现：</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><h4 id="inc-config-h-1"><a href="#inc-config-h-1" class="headerlink" title="inc/config.h"></a><code>inc/config.h</code></h4><p>新增选项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONF_MFQ</span><br></code></pre></td></tr></table></figure>

<h4 id="inc-env-h-1"><a href="#inc-env-h-1" class="headerlink" title="inc/env.h"></a><code>inc/env.h</code></h4><p>在<code>struct Env</code>中添加以下成员，用于记录必要信息（取名比较直白，就不注释说明了）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>    EmbedLink env_mfq_link;<br>    <span class="hljs-type">uint32_t</span> env_mfq_level;<br>    <span class="hljs-type">int</span> env_mfq_left_ticks;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<h4 id="kern-env-h"><a href="#kern-env-h" class="headerlink" title="kern/env.h"></a><code>kern/env.h</code></h4><p>添加以下内容。其中<code>env_ready(e)</code>可用于代替所有的<code>e-&gt;env_status = ENV_RUNNABLE</code>语句，修改的地方不再赘述：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ </span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NMFQ 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MFQ_SLICE 2</span><br><span class="hljs-keyword">extern</span> EmbedLink* mfqs;<br><br><span class="hljs-type">void</span> 	<span class="hljs-title function_">env_mfq_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* e)</span>;<br><span class="hljs-type">void</span> 	<span class="hljs-title function_">env_mfq_pop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* e)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">void</span> 	<span class="hljs-title function_">env_ready</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* e)</span>;<br></code></pre></td></tr></table></figure>

<h4 id="kern-pmap-c"><a href="#kern-pmap-c" class="headerlink" title="kern/pmap.c"></a><code>kern/pmap.c</code></h4><p>在<code>mem_init</code>初始化<code>mfq</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>	<span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br>	<span class="hljs-comment">// Make 'mfqs' point to an array of size 'NMFQ' of 'EmbedLink'.</span><br>	mfqs = (EmbedLink* ) boot_alloc(NMFQ * <span class="hljs-keyword">sizeof</span>(EmbedLink));<br>	<span class="hljs-built_in">memset</span>(mfqs, <span class="hljs-number">0</span>, NMFQ * <span class="hljs-keyword">sizeof</span>(EmbedLink));<br>	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span> ; i &lt; NMFQ; ++i)<br>		elink_init(&amp;mfqs[i]);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<h4 id="kern-env-c-1"><a href="#kern-env-c-1" class="headerlink" title="kern/env.c"></a><code>kern/env.c</code></h4><p>实现MFQ相关函数。</p>
<p>其中<code>env_mfq_add</code>用于将进程加入队列，通常通过<code>env_ready</code>调用。</p>
<p><code>env_mfq_pop</code>将进程从队列中移除。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>EmbedLink* mfqs = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">env_mfq_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span> <br>{<br>	elink_remove(&amp;e-&gt;env_mfq_link);<br>	<span class="hljs-keyword">if</span> (e-&gt;env_mfq_left_ticks &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// time slice left</span><br>         <span class="hljs-comment">// add to queue's head</span><br>		elink_insert(&amp;mfqs[e-&gt;env_mfq_level], &amp;e-&gt;env_mfq_link);	<br>	} <span class="hljs-keyword">else</span> { <span class="hljs-comment">// no time slice left</span><br>		<span class="hljs-type">uint32_t</span> lv = MIN(e-&gt;env_mfq_level + <span class="hljs-number">1</span>, NMFQ - <span class="hljs-number">1</span>);<br>		e-&gt;env_mfq_level = lv;<br>		e-&gt;env_mfq_left_ticks = (<span class="hljs-number">1</span> &lt;&lt; lv) * MFQ_SLICE;<br>		elink_enqueue(&amp;mfqs[lv], &amp;e-&gt;env_mfq_link);<br>	}<br>}<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">env_mfq_pop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* e)</span><br>{<br>	elink_remove(&amp;e-&gt;env_mfq_link);<br>}<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">env_ready</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env* e)</span><br>{<br>	e-&gt;env_status = ENV_RUNNABLE;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>	env_mfq_add(e);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>}<br></code></pre></td></tr></table></figure>

<p>在<code>env_alloc</code>中初始化相关成员：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>	e-&gt;env_mfq_level = <span class="hljs-number">0</span>;<br>	e-&gt;env_mfq_left_ticks = MFQ_SLICE;<br>	elink_enqueue(&amp;mfqs[<span class="hljs-number">0</span>], &amp;e-&gt;env_mfq_link);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>在<code>env_free</code>中处理相关成员：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>	e-&gt;env_mfq_level = <span class="hljs-number">0</span>;<br>	e-&gt;env_mfq_left_ticks = <span class="hljs-number">0</span>;<br>	env_mfq_pop(e);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>修改<code>env_run</code>，将当前要运行的进程从队列中移除。注意，只要进程不处于就绪态就要从MFQ中移除，包括IPC发送、接收时的阻塞，这些方面的修改就不再赘述了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">env_run</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span><br>{<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">olde</span> =</span> curenv;<br><br>    <span class="hljs-keyword">if</span> (olde &amp;&amp; olde-&gt;env_status == ENV_RUNNING)<br>        env_ready(olde);<br>    curenv = e;<br>    e-&gt;env_status = ENV_RUNNING;<br>    e-&gt;env_runs += <span class="hljs-number">1</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>    env_mfq_pop(e);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (olde != e) <span class="hljs-comment">// 只有进程切换才进行，尽可能避免TLB失效</span><br>        lcr3(PADDR(e-&gt;env_pgdir));<br>    unlock_kernel();<br>    env_pop_tf(&amp;e-&gt;env_tf);<br>}<br></code></pre></td></tr></table></figure>

<h4 id="kern-sched-c"><a href="#kern-sched-c" class="headerlink" title="kern/sched.c"></a><code>kern/sched.c</code></h4><p>修改<code>sched_yield</code>函数，实现MFQ调度算法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONF_MFQ</span><br><span class="hljs-comment">// RR scheduler</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span> </span><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">sched_yield</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">idle</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NMFQ; ++i) {<br>        <span class="hljs-keyword">if</span> (!elink_empty(&amp;mfqs[i])) {<br>            idle = master(elink_queue_head(&amp;mfqs[i]), <span class="hljs-keyword">struct</span> Env, env_mfq_link);<br>            <span class="hljs-comment">// assert(idle-&gt;env_status == ENV_RUNNABLE);</span><br>            <span class="hljs-keyword">if</span> (idle-&gt;env_status != ENV_RUNNABLE) {<br>                log_int(idle-&gt;env_status);<br>                panic(<span class="hljs-string">"only runnable env can be in mfq"</span>);	<br>            }<br>            <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>    <span class="hljs-keyword">if</span> (idle) {<br>        env_run(idle);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (curenv &amp;&amp; curenv-&gt;env_status == ENV_RUNNING) {<br>        env_run(curenv);<br>    }<br>    sched_halt();<br>}<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<h4 id="kern-trap-c"><a href="#kern-trap-c" class="headerlink" title="kern/trap.c"></a><code>kern/trap.c</code></h4><p>在<code>trap_dispatch</code>中修改对时钟中断的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C">    <span class="hljs-keyword">if</span> (tf-&gt;tf_trapno == IRQ_OFFSET + IRQ_TIMER) {<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONF_MFQ</span><br>        lapic_eoi();<br>        sched_yield();<br>        <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">cure</span> =</span> curenv;<br>        lapic_eoi();<br>        <span class="hljs-keyword">if</span> (cure &amp;&amp; cure-&gt;env_mfq_left_ticks-- == <span class="hljs-number">1</span>) {<br>            sched_yield();<br>        }<br>        <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    }<br></code></pre></td></tr></table></figure>

<h2 id="Challenge-Process-snapshot-and-rollback"><a href="#Challenge-Process-snapshot-and-rollback" class="headerlink" title="Challenge: Process snapshot and rollback"></a>Challenge: Process snapshot and rollback</h2><h3 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h3><p>实现了两个系统调用<code>sys_snapshot</code>和<code>sys_rollback</code>。</p>
<p>接口如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">envid_t</span>	<span class="hljs-title function_">sys_env_snapshot</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *dmail_store)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">sys_env_rollback</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> spst, <span class="hljs-type">uint32_t</span> dmail)</span>;<br></code></pre></td></tr></table></figure>

<p><code>sys_env_snapshot</code>：</p>
<ul>
<li>参数<code>dmail_store</code>：用于存储来自“未来”的信息。</li>
<li>返回envid：作为snapshot的标识。</li>
<li>出错返回负数。</li>
</ul>
<p><code>sys_env_rollback</code>：</p>
<ul>
<li>参数<code>spst</code>：回滚的目标snapshot。</li>
<li>参数<code>dmail</code>：传递给“过去”的信息。</li>
<li>通常不返回，出错则返回负数。</li>
</ul>
<p>以下为一个使用示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inc/lib.h&gt;</span></span><br><br><span class="hljs-type">int</span> min = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <br><span class="hljs-title function_">umain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span><br>{<br>    <span class="hljs-type">uint32_t</span> dmail = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> sec = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">envid_t</span> spst = sys_env_snapshot(&amp;dmail);<br>    <span class="hljs-keyword">if</span> (dmail == EMPTY_DMAIL) {<br>        sys_env_rollback(spst, <span class="hljs-number">0</span>);<br>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dmail &lt; <span class="hljs-number">10</span>) {<br>        cprintf(<span class="hljs-string">"recv dmail %d at time(%d:%d)\n"</span>, dmail, min++, sec++);<br>        sys_env_rollback(spst, ++dmail);<br>    }<br>}<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">[00000000] new env 00001000<br>[00001000] new env 00001001<br>recv dmail 0 at time(0:0)<br>recv dmail 1 at time(0:0)<br>recv dmail 2 at time(0:0)<br>recv dmail 3 at time(0:0)<br>recv dmail 4 at time(0:0)<br>recv dmail 5 at time(0:0)<br>recv dmail 6 at time(0:0)<br>recv dmail 7 at time(0:0)<br>recv dmail 8 at time(0:0)<br>recv dmail 9 at time(0:0)<br>[00001000] exiting gracefully<br>[00001000] free env 00001000<br>[00001000] free env 00001001<br>No runnable environments in the system!<br></code></pre></td></tr></table></figure>

<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>基本原理和fork类似，不过核心部分均在内核而不是用户态实现（主要是出于效率方面的考虑）：</p>
<ul>
<li>snapshot的时候分配一个新的快照进程，加入当前进程的快照列表中（每个进程可以持有多个快照，按时间排列）；用类似fork的方式复制当前进程的页到快照进程。</li>
<li>rollback的时候，先将快照列表中目标快照之后的快照释放（符合直觉，而且可以防止不断回滚不断重复做快照让PCB耗尽）。之后用目标快照恢复当前进程的寄存器、内存等信息。</li>
</ul>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><h3 id="inc-env-h-2"><a href="#inc-env-h-2" class="headerlink" title="inc/env.h"></a><code>inc/env.h</code></h3><p>新增一个<code>EnvType</code>：<code>ENV_TYPE_SPST</code>，用于表示作为快照的进程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// Special environment types</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">EnvType</span> {</span><br>    ENV_TYPE_USER = <span class="hljs-number">0</span>,<br>    ENV_TYPE_SPST,  <span class="hljs-comment">// snapshot</span><br>};<br></code></pre></td></tr></table></figure>

<p>在<code>struct Env</code>中新增以下成员：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">    EmbedLink env_spst_link;    <span class="hljs-comment">// Embeded link to the snapshot list</span><br>    <span class="hljs-type">envid_t</span> env_spst_owner_id;  <span class="hljs-comment">// snapshot's owner env's id</span><br>    <span class="hljs-type">envid_t</span> env_spst_id;        <span class="hljs-comment">// rollbacked snapshot's id</span><br>    <span class="hljs-type">uint32_t</span> env_spst_dmail;    <span class="hljs-comment">// DeLorean-Mail（这一切都是命运石之门的选择!）</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EMPTY_DMAIL ~0U</span><br></code></pre></td></tr></table></figure>

<h3 id="kern-syscall-c-2"><a href="#kern-syscall-c-2" class="headerlink" title="kern/syscall.c"></a><code>kern/syscall.c</code></h3><p>实现<code>sys_env_snapshot</code>和<code>sys_env_rollback</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">envid_t</span><br><span class="hljs-title function_">sys_env_snapshot</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK(x) do {<span class="hljs-keyword">if</span> (r = (x), r &lt; 0) return r;} while(0)</span><br><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">cure</span> =</span> curenv;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">e</span>;</span><br>    <br>    CHECK(env_alloc(&amp;e, cure-&gt;env_id));<br><br>    e-&gt;env_tf = cure-&gt;env_tf;<br>    e-&gt;env_status = ENV_NOT_RUNNABLE;<br>    e-&gt;env_type = ENV_TYPE_SPST;<br>    e-&gt;env_spst_owner_id = cure-&gt;env_id;<br>    elink_enqueue(&amp;cure-&gt;env_spst_link, &amp;e-&gt;env_spst_link);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_MFQ</span><br>    env_mfq_pop(e);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> pdeno = <span class="hljs-number">0</span>; pdeno &lt; PDX(UTOP); ++pdeno) {<br>        <span class="hljs-keyword">if</span> ((cure-&gt;env_pgdir[pdeno] &amp; PTE_P) == <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-type">pte_t</span>* pt = (<span class="hljs-type">pte_t</span>*)KADDR(PTE_ADDR(cure-&gt;env_pgdir[pdeno]));<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> pteno = <span class="hljs-number">0</span>; pteno &lt; NPDENTRIES; ++pteno) {<br>            <span class="hljs-keyword">if</span> (pt[pteno] &amp; PTE_P) {<br>                <span class="hljs-type">pte_t</span> pte = pt[pteno];<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span>* <span class="hljs-title">pp</span> =</span> pa2page(PTE_ADDR(pte));<br>                <span class="hljs-type">void</span>* va = PGADDR(pdeno, pteno, <span class="hljs-number">0</span>);<br>                assert(pte &amp; PTE_U);<br>                <span class="hljs-keyword">if</span> (pte &amp; PTE_W || pte &amp; PTE_COW) {<br>                    CHECK(page_insert(e-&gt;env_pgdir, pp, va, PTE_P | PTE_U | PTE_COW));<br>                    CHECK(page_insert(cure-&gt;env_pgdir, pp, va, PTE_P | PTE_U | PTE_COW));<br>                } <span class="hljs-keyword">else</span> {<br>                    CHECK(page_insert(e-&gt;env_pgdir, pp, va, PTE_P | PTE_U));<br>                }<br>            }<br>        }<br>    }<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span>* <span class="hljs-title">pp</span> =</span> page_lookup(cure-&gt;env_pgdir, (<span class="hljs-type">void</span>*)(UXSTACKTOP - PGSIZE), <span class="hljs-number">0</span>);<br>    CHECK(page_insert(e-&gt;env_pgdir, pp, (<span class="hljs-type">void</span>*)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W));<br>    CHECK(page_insert(cure-&gt;env_pgdir, pp, (<span class="hljs-type">void</span>*)(UXSTACKTOP - PGSIZE), PTE_P | PTE_U | PTE_W));<br><br>    cure-&gt;env_spst_dmail = EMPTY_DMAIL;<br><br>    <span class="hljs-keyword">return</span> e-&gt;env_id;<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> CHECK</span><br>}<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <br><span class="hljs-title function_">sys_env_rollback</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> eid, <span class="hljs-type">uint32_t</span> dmail)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHECK(x) do {<span class="hljs-keyword">if</span> (r = (x), r &lt; 0) return r;} while(0)</span><br><br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">cure</span> =</span> curenv;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">e</span>;</span><br>    <span class="hljs-type">envid_t</span> ceid;<br><br>    CHECK(envid2env(eid, &amp;e, <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">if</span> (e-&gt;env_type != ENV_TYPE_SPST || e-&gt;env_spst_owner_id != cure-&gt;env_id)<br>        <span class="hljs-keyword">return</span> -E_INVAL;<br><br>    <span class="hljs-comment">// 将该快照之后记录的快照全部删除</span><br>    <span class="hljs-keyword">for</span>(EmbedLink* ln = &amp;e-&gt;env_spst_link; ln-&gt;next != &amp;cure-&gt;env_spst_link; ) {<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span>* <span class="hljs-title">tmpe</span> =</span> master(elink_remove(ln-&gt;next), <span class="hljs-keyword">struct</span> Env, env_spst_link);<br>        env_free(tmpe);<br>    }<br><br>    <span class="hljs-comment">// 将快照进程的页映射到当前进程，并将当前进程多余的页删去</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> pdeno = <span class="hljs-number">0</span>; pdeno &lt; PDX(UTOP); ++pdeno) {<br>        <span class="hljs-keyword">if</span> (e-&gt;env_pgdir[pdeno] &amp; PTE_P) {<br>            <span class="hljs-type">pte_t</span> *pt = (<span class="hljs-type">pte_t</span> *)KADDR(PTE_ADDR(e-&gt;env_pgdir[pdeno]));<br>            <span class="hljs-type">pte_t</span> *pt2 = (cure-&gt;env_pgdir[pdeno] &amp; PTE_P)<br>                             ? (<span class="hljs-type">pte_t</span> *)KADDR(PTE_ADDR(cure-&gt;env_pgdir[pdeno]))<br>                             : <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> pteno = <span class="hljs-number">0</span>; pteno &lt; NPDENTRIES; ++pteno) {<br>                <span class="hljs-keyword">if</span> (pt[pteno] &amp; PTE_P) {<br>                    <span class="hljs-type">pte_t</span> pte = pt[pteno];<br>                    CHECK(page_insert(cure-&gt;env_pgdir, pa2page(PTE_ADDR(pte)),<br>                                PGADDR(pdeno, pteno, <span class="hljs-number">0</span>), pte &amp; PTE_SYSCALL));<br>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pt2 &amp;&amp; pt2[pteno] &amp; PTE_P) {<br>                    page_remove(cure-&gt;env_pgdir, PGADDR(pdeno, pteno, <span class="hljs-number">0</span>));<br>                }<br>            }<br>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cure-&gt;env_pgdir[pdeno] &amp; PTE_P) {<br>            <span class="hljs-type">pte_t</span> *pt = (<span class="hljs-type">pte_t</span>*)KADDR(PTE_ADDR(cure-&gt;env_pgdir[pdeno]));<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> pteno = <span class="hljs-number">0</span>; pteno &lt; NPDENTRIES; ++pteno) {<br>                <span class="hljs-keyword">if</span> (pt[pteno] &amp; PTE_P)<br>                    page_remove(cure-&gt;env_pgdir, PGADDR(pdeno, pteno, <span class="hljs-number">0</span>));<br>            }<br>        }<br>    }<br><br>    cure-&gt;env_tf = e-&gt;env_tf;<br>    cure-&gt;env_spst_dmail = dmail;<br><br>    <span class="hljs-keyword">return</span> e-&gt;env_id;<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> CHECK</span><br>}<br></code></pre></td></tr></table></figure>

<h3 id="lib-fork-c"><a href="#lib-fork-c" class="headerlink" title="lib/fork.c"></a><code>lib/fork.c</code></h3><p>实现<code>sys_env_snapshot</code>用户态的接口。之所以在<code>lib/fork.c</code>而不是<code>lib/syscall.c</code>里实现是为了设置page fault handler为<code>pgfault</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int32_t</span><br><span class="hljs-title function_">syscall</span><span class="hljs-params">(<span class="hljs-type">int</span> num, <span class="hljs-type">int</span> check, <span class="hljs-type">uint32_t</span> a1, <span class="hljs-type">uint32_t</span> a2, <span class="hljs-type">uint32_t</span> a3, <span class="hljs-type">uint32_t</span> a4, <span class="hljs-type">uint32_t</span> a5)</span><br>{<br>	<span class="hljs-type">int32_t</span> ret;<br><br>	<span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">"int %1\n"</span></span><br><span class="hljs-params">		     : <span class="hljs-string">"=a"</span> (ret)</span><br><span class="hljs-params">		     : <span class="hljs-string">"i"</span> (T_SYSCALL),</span><br><span class="hljs-params">		       <span class="hljs-string">"a"</span> (num),</span><br><span class="hljs-params">		       <span class="hljs-string">"d"</span> (a1),</span><br><span class="hljs-params">		       <span class="hljs-string">"c"</span> (a2),</span><br><span class="hljs-params">		       <span class="hljs-string">"b"</span> (a3),</span><br><span class="hljs-params">		       <span class="hljs-string">"D"</span> (a4),</span><br><span class="hljs-params">		       <span class="hljs-string">"S"</span> (a5)</span><br><span class="hljs-params">		     : <span class="hljs-string">"cc"</span>, <span class="hljs-string">"memory"</span>)</span>;<br><br>	<span class="hljs-keyword">if</span>(check &amp;&amp; ret &gt; <span class="hljs-number">0</span>)<br>		panic(<span class="hljs-string">"syscall %d returned %d (&gt; 0)"</span>, num, ret);<br><br>	<span class="hljs-keyword">return</span> ret;<br>}<br><br><span class="hljs-type">envid_t</span><br><span class="hljs-title function_">sys_env_snapshot</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *dmail_store)</span><br>{<br> <span class="hljs-meta">#<span class="hljs-keyword">define</span> PANIC panic(<span class="hljs-string">"sys_env_snapshot: %e"</span>, r)</span><br><br>    <span class="hljs-type">int</span> r;<br>    set_pgfault_handler(pgfault);<br><br>    <span class="hljs-keyword">if</span> (r = syscall(SYS_env_snapshot, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), r &lt; <span class="hljs-number">0</span>)<br>        PANIC;<br>    <span class="hljs-keyword">if</span> (dmail_store)<br>        *dmail_store = thisenv-&gt;env_spst_dmail;<br>    <span class="hljs-keyword">return</span> r;<br><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> PANIC   </span><br>}<br></code></pre></td></tr></table></figure>

<h3 id="lib-syscall-c"><a href="#lib-syscall-c" class="headerlink" title="lib/syscall.c"></a><code>lib/syscall.c</code></h3><p>实现<code>sys_env_rollback</code>的用户态接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <br><span class="hljs-title function_">sys_env_rollback</span><span class="hljs-params">(<span class="hljs-type">envid_t</span> eid, <span class="hljs-type">uint32_t</span> dmail)</span><br>{<br>	<span class="hljs-keyword">if</span> (dmail == EMPTY_DMAIL)<br>		<span class="hljs-keyword">return</span> -E_INVAL;<br>	<span class="hljs-type">int</span> r = syscall(SYS_env_rollback, <span class="hljs-number">1</span>, (<span class="hljs-type">uint32_t</span>)eid, dmail, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>)<br>		panic(<span class="hljs-string">"rollback should never return"</span>);<br>	<span class="hljs-keyword">return</span> r;<br>}<br></code></pre></td></tr></table></figure>

<h2 id="Compatible-to-Page-Size-Extension"><a href="#Compatible-to-Page-Size-Extension" class="headerlink" title="Compatible to Page Size Extension"></a>Compatible to Page Size Extension</h2><p>在本Lab的多处理器环境下若要兼容Lab2一个Challenge中的大页扩展，需要在<code>kern/init.c</code>的<code>mp_main</code>函数内，加载页表之前设置好CR4寄存器的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span><br><span class="hljs-title function_">mp_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONF_HUGE_PAGE</span><br>	<span class="hljs-comment">// Enable page size extension</span><br>	<span class="hljs-type">uint32_t</span> cr4;<br>	cr4 = rcr4();<br>	cr4 |= CR4_PSE;<br>	lcr4(cr4);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-comment">// We are in high EIP now, safe to switch to kern_pgdir </span><br>	lcr3(PADDR(kern_pgdir));<br>	<span class="hljs-comment">// ......</span><br>}<br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2020/10/05/MIT%206.828%20JOS%20Lab6%20%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">← Next MIT 6.828 JOS Lab6 实验报告</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2020/10/05/MIT%206.828%20JOS%20Lab5%20%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/">MIT 6.828 JOS Lab5 实验报告 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a target="_blank" rel="noopener" href="https://prts.wiki/w/%E6%96%87%E4%BB%B6:%E6%A8%A1%E7%BB%84_%E5%8C%BB%E4%B8%8D%E8%87%AA%E6%B2%BB.png" id="logo"><img src="/imgs/avatar.png" alt="Logo"></a><h1 id="Dr"><a href="/">Renze Chen</a></h1><div id="description"><p>陈仁泽</p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/Light-of-Hers"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://www.zhihu.com/people/yi-guang-99-48"><i class="fab fa-zhihu" alt="Zhihu"></i></a><a class="social" target="_blank" rel="noopener" href="https://orcid.org/0000-0001-5938-7965"><i class="fab fa-orcid" alt="ORCID"></i></a><a class="social" target="_blank" rel="noopener" href="https://dblp.org/pid/260/5910"><i class="iconfont icon-dblp" alt="DBLP"></i></a><a class="social" href="mailto:crz@pku.edu.cn"><i class="fa fa-envelope" alt="E-Mail"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-1"><span class="toc-number">2.</span> <span class="toc-text">Exercise 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-2"><span class="toc-number">3.</span> <span class="toc-text">Exercise 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-3"><span class="toc-number">4.</span> <span class="toc-text">Exercise 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-4"><span class="toc-number">5.</span> <span class="toc-text">Exercise 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-5"><span class="toc-number">6.</span> <span class="toc-text">Exercise 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-6"><span class="toc-number">7.</span> <span class="toc-text">Exercise 6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-7"><span class="toc-number">8.</span> <span class="toc-text">Exercise 7</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-exofork"><span class="toc-number">8.1.</span> <span class="toc-text">sys_exofork</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-env-set-status"><span class="toc-number">8.2.</span> <span class="toc-text">sys_env_set_status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-page-alloc"><span class="toc-number">8.3.</span> <span class="toc-text">sys_page_alloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-page-map"><span class="toc-number">8.4.</span> <span class="toc-text">sys_page_map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-page-unmap"><span class="toc-number">8.5.</span> <span class="toc-text">sys_page_unmap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-8"><span class="toc-number">9.</span> <span class="toc-text">Exercise 8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-9"><span class="toc-number">10.</span> <span class="toc-text">Exercise 9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-10"><span class="toc-number">11.</span> <span class="toc-text">Exercise 10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-11"><span class="toc-number">12.</span> <span class="toc-text">Exercise 11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-12"><span class="toc-number">13.</span> <span class="toc-text">Exercise 12</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fork"><span class="toc-number">13.1.</span> <span class="toc-text">fork</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#duppage"><span class="toc-number">13.2.</span> <span class="toc-text">duppage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pgfault"><span class="toc-number">13.3.</span> <span class="toc-text">pgfault</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-13"><span class="toc-number">14.</span> <span class="toc-text">Exercise 13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-14"><span class="toc-number">15.</span> <span class="toc-text">Exercise 14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exercise-15"><span class="toc-number">16.</span> <span class="toc-text">Exercise 15</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kern-syscall-c"><span class="toc-number">16.1.</span> <span class="toc-text">kern&#x2F;syscall.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lib-ipc-c"><span class="toc-number">16.2.</span> <span class="toc-text">lib&#x2F;ipc.c</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#This-completes-this-lab"><span class="toc-number">17.</span> <span class="toc-text">This completes this lab</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge-Sleep-IPC"><span class="toc-number">18.</span> <span class="toc-text">Challenge: Sleep IPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0"><span class="toc-number">18.1.</span> <span class="toc-text">描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">18.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">18.3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#inc-config-h"><span class="toc-number">18.3.1.</span> <span class="toc-text">inc&#x2F;config.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inc-elink-h"><span class="toc-number">18.3.2.</span> <span class="toc-text">inc&#x2F;elink.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inc-env-h"><span class="toc-number">18.3.3.</span> <span class="toc-text">inc&#x2F;env.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-env-c"><span class="toc-number">18.3.4.</span> <span class="toc-text">kern&#x2F;env.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-syscall-c-1"><span class="toc-number">18.3.5.</span> <span class="toc-text">kern&#x2F;syscall.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lib-ipc-h"><span class="toc-number">18.3.6.</span> <span class="toc-text">lib&#x2F;ipc.h</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge-Multilevel-Feedback-Queue"><span class="toc-number">19.</span> <span class="toc-text">Challenge: Multilevel Feedback Queue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">19.1.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#inc-config-h-1"><span class="toc-number">19.1.1.</span> <span class="toc-text">inc&#x2F;config.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inc-env-h-1"><span class="toc-number">19.1.2.</span> <span class="toc-text">inc&#x2F;env.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-env-h"><span class="toc-number">19.1.3.</span> <span class="toc-text">kern&#x2F;env.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-pmap-c"><span class="toc-number">19.1.4.</span> <span class="toc-text">kern&#x2F;pmap.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-env-c-1"><span class="toc-number">19.1.5.</span> <span class="toc-text">kern&#x2F;env.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-sched-c"><span class="toc-number">19.1.6.</span> <span class="toc-text">kern&#x2F;sched.c</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kern-trap-c"><span class="toc-number">19.1.7.</span> <span class="toc-text">kern&#x2F;trap.c</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge-Process-snapshot-and-rollback"><span class="toc-number">20.</span> <span class="toc-text">Challenge: Process snapshot and rollback</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">20.1.</span> <span class="toc-text">描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">20.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">20.3.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inc-env-h-2"><span class="toc-number">20.4.</span> <span class="toc-text">inc&#x2F;env.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kern-syscall-c-2"><span class="toc-number">20.5.</span> <span class="toc-text">kern&#x2F;syscall.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lib-fork-c"><span class="toc-number">20.6.</span> <span class="toc-text">lib&#x2F;fork.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lib-syscall-c"><span class="toc-number">20.7.</span> <span class="toc-text">lib&#x2F;syscall.c</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Compatible-to-Page-Size-Extension"><span class="toc-number">21.</span> <span class="toc-text">Compatible to Page Size Extension</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main></body></html>